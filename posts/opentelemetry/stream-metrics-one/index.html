<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.139.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.png><meta itemprop=name content="VictoriaMetrics的指标流聚合能力应用"><meta itemprop=description content="What is rational is real; and what is real is rational."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/icons/custom.png"><meta itemprop=keywords content="Prometheus,VictoriaMetrics"><meta property="og:type" content="article"><meta property="og:title" content="VictoriaMetrics的指标流聚合能力应用"><meta property="og:description" content="What is rational is real; and what is real is rational."><meta property="og:image" content="/imgs/icons/custom.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/posts/opentelemetry/stream-metrics-one/"><meta property="og:site_name" content="蓝宝石的傻话"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="蓝宝石的傻话"><meta property="article:published_time" content="2023-03-27 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2023-03-27 00:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.374a99719ba5f425af97e9e4d4b002d4efa1a29ac3be3b0cb855d613bc1fbddf.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"stream-metrics-one","permalink":"/posts/opentelemetry/stream-metrics-one/","title":"VictoriaMetrics的指标流聚合能力应用","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>VictoriaMetrics的指标流聚合能力应用 - 蓝宝石的傻话</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>蓝宝石的傻话</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>MickeyBee's BLOG</p><img class=custom-logo-image src=/imgs/icons/custom.png alt=蓝宝石的傻话></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>14</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#社区vm对指标流聚合能力分析与问题>社区VM对指标流聚合能力分析与问题</a><ul><li><a href=#victoriametrics开源项目的原生能力>VictoriaMetrics开源项目的原生能力</a></li><li><a href=#流聚合能力的一般运用分析>流聚合能力的一般运用分析</a></li><li><a href=#原生流聚合能力的日常问题>原生流聚合能力的日常问题</a><ul><li><a href=#采集断点问题>采集断点问题</a></li><li><a href=#巨量数据的算力架构>巨量数据的算力架构</a></li></ul></li></ul></li><li><a href=#分布式流聚合的网关设计与实现>分布式流聚合的网关设计与实现</a><ul><li><a href=#分布式流聚合网关处理的问题>分布式流聚合网关处理的问题</a><ul><li><a href=#异步>异步</a></li><li><a href=#时间窗口的过滤>时间窗口的过滤</a></li><li><a href=#维度控制>维度控制</a></li><li><a href=#双重hashmod调度分配任务>双重hashmod调度分配任务</a></li><li><a href=#后端异常服务转移>后端异常服务转移</a></li></ul></li><li><a href=#程序流程逻辑图>程序流程逻辑图</a></li><li><a href=#线上环境架构图>线上环境架构图</a></li></ul></li><li><a href=#record-rule维度任务生成器>Record Rule维度任务生成器</a></li><li><a href=#指标流聚合在监控平台的架构组合>指标流聚合在监控平台的架构组合</a><ul><li><a href=#万级别单一指标的流聚合>万级别单一指标的流聚合</a></li><li><a href=#万级别多指标的计算聚合>万级别多指标的计算聚合</a></li><li><a href=#百万级别以上的单一指标流聚合>百万级别以上的单一指标流聚合</a></li><li><a href=#百万级别以上的指标对场景的计算聚合>百万级别以上的指标对场景的计算聚合</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=蓝宝石的傻话 src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpeg><p class=site-author-name itemprop=name>蓝宝石的傻话</p><div class=site-description itemprop=description>What is rational is real; and what is real is rational.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>14</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>10</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/mickeyzzc title="Github → https://github.com/mickeyzzc" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=https://gitee.com/mickeybee title="Gitee → https://gitee.com/mickeybee" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Gitee
</a></span><span class=links-of-social-item><a href=mailto:mickey_zzc@163.com title="E-Mail → mailto:mickey_zzc@163.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://blog.51cto.com/mickeyzzc title=https://blog.51cto.com/mickeyzzc target=_blank>我的51cto博客</a></li><li class=links-of-blogroll-item><a href=https://deepflow.io/ title=https://deepflow.io/ target=_blank>DeepFlow</a></li><li class=links-of-blogroll-item><a href=https://blog.csdn.net/mickey_zzc title=https://blog.csdn.net/mickey_zzc target=_blank>CSDN博客</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2016-08-11T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=31195></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=68></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-11-25T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/mickeyzzc rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/stream-metrics-one/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="VictoriaMetrics的指标流聚合能力应用"><meta itemprop=description content="社区VM对指标流聚合能力分析与问题

VictoriaMetrics开源项目的原生能力

VictoriaMetrics项目中的流聚合能力是从1.86版本开始整合到vmagent的，具体可参考： 

    https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460
    
    
    

从源码分析来看，流集合能力如图："></span><header class=post-header><h1 class=post-title itemprop="name headline">VictoriaMetrics的指标流聚合能力应用
<a href=https://github.com/mickeyzzc/mickeyzzcblog/tree/main/content/posts/opentelemetry/stream-metrics-one.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-03-27 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-03-27 00:00:00 +0000 UTC">2023-03-27
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/victoriametrics itemprop=url rel=index><span itemprop=name>Prometheus/VictoriaMetrics</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>3394</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>7分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/posts/opentelemetry/stream-metrics-one/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=社区vm对指标流聚合能力分析与问题>社区VM对指标流聚合能力分析与问题
<a class=header-anchor href=#%e7%a4%be%e5%8c%bavm%e5%af%b9%e6%8c%87%e6%a0%87%e6%b5%81%e8%81%9a%e5%90%88%e8%83%bd%e5%8a%9b%e5%88%86%e6%9e%90%e4%b8%8e%e9%97%ae%e9%a2%98></a></h2><h3 id=victoriametrics开源项目的原生能力>VictoriaMetrics开源项目的原生能力
<a class=header-anchor href=#victoriametrics%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae%e7%9a%84%e5%8e%9f%e7%94%9f%e8%83%bd%e5%8a%9b></a></h3><p>VictoriaMetrics项目中的流聚合能力是从1.86版本开始整合到vmagent的，具体可参考：
<a href=https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460 title=https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460
<i class="fa fa-external-link-alt"></i>
</a>从源码分析来看，流集合能力如图：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/20230329181637.png alt></p><p>核心计算的代码在<code>pushSample</code>函数中有描述：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>as</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>totalAggrState</span>) <span style=color:#a6e22e>pushSample</span>(<span style=color:#a6e22e>inputKey</span>, <span style=color:#a6e22e>outputKey</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>float64</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>currentTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fasttime</span>.<span style=color:#a6e22e>UnixTimestamp</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>deleteDeadline</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>currentTime</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>intervalSecs</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>intervalSecs</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>again</span>:
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>outputKey</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>v</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalStateValue</span>{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>lastValues</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>lastValueState</span>),
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>vNew</span>, <span style=color:#a6e22e>loaded</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>LoadOrStore</span>(<span style=color:#a6e22e>outputKey</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>loaded</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>vNew</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>totalStateValue</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>deleted</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>deleted</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>deleted</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lv</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>lastValues</span>[<span style=color:#a6e22e>inputKey</span>]
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>lv</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>lastValueState</span>{}
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>lastValues</span>[<span style=color:#a6e22e>inputKey</span>] = <span style=color:#a6e22e>lv</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>value</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>d</span> = <span style=color:#a6e22e>value</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>currentTime</span> &gt; <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>ignoreInputDeadline</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>deleteDeadline</span> = <span style=color:#a6e22e>deleteDeadline</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>deleteDeadline</span> = <span style=color:#a6e22e>deleteDeadline</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>deleted</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>goto</span> <span style=color:#a6e22e>again</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h3 id=流聚合能力的一般运用分析>流聚合能力的一般运用分析
<a class=header-anchor href=#%e6%b5%81%e8%81%9a%e5%90%88%e8%83%bd%e5%8a%9b%e7%9a%84%e4%b8%80%e8%88%ac%e8%bf%90%e7%94%a8%e5%88%86%e6%9e%90></a></h3><p>首先先看看流聚合后的时序图：
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/20230330154038.png alt></p><p>这时候，我们看看时序数据的理论形态
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%97%b6%e5%ba%8f%e6%95%b0%e6%8d%aeBase%e6%8f%8f%e8%bf%b0.svg alt></p><p>基于理论形态的理想流聚合形态
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e7%90%86%e8%ae%ba%e5%bd%a2%e6%80%81%e7%9a%84%e7%90%86%e6%83%b3%e6%b5%81%e8%81%9a%e5%90%88%e5%bd%a2%e6%80%81.svg alt></p><p>在实际状态下的流聚合形态
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%ae%9e%e9%99%85%e7%8a%b6%e6%80%81%e4%b8%8b%e7%9a%84%e6%b5%81%e8%81%9a%e5%90%88%e5%bd%a2%e6%80%81.svg alt></p><h3 id=原生流聚合能力的日常问题>原生流聚合能力的日常问题
<a class=header-anchor href=#%e5%8e%9f%e7%94%9f%e6%b5%81%e8%81%9a%e5%90%88%e8%83%bd%e5%8a%9b%e7%9a%84%e6%97%a5%e5%b8%b8%e9%97%ae%e9%a2%98></a></h3><h4 id=采集断点问题>采集断点问题
<a class=header-anchor href=#%e9%87%87%e9%9b%86%e6%96%ad%e7%82%b9%e9%97%ae%e9%a2%98></a></h4><p>在现实世界是更残酷的，某个时间断点是无可避免，原因很多，有网络上的、有被采集服务的性能问题等。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%ae%9e%e9%99%85%e7%8a%b6%e6%80%81%e4%b8%8b%e7%9a%84%e6%b5%81%e8%81%9a%e5%90%88%e7%9a%84%e6%96%ad%e7%82%b9%e9%97%ae%e9%a2%98.svg alt>
高精度的流聚合断点问题在大数计算情况下，影响是很极端的：
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/20230330154258.png alt></p><h4 id=巨量数据的算力架构>巨量数据的算力架构
<a class=header-anchor href=#%e5%b7%a8%e9%87%8f%e6%95%b0%e6%8d%ae%e7%9a%84%e7%ae%97%e5%8a%9b%e6%9e%b6%e6%9e%84></a></h4><p>流聚合没有历史数据细节的状态保存，因此性能极优，但是再优性能的服务也存在单点的极限值。在处理单点无法处理的数据量级情况下，分布式算力结构就会存在一系列问题要解决：</p><ul><li><h5 id=vmagent自带采集能力是否可用>vmagent自带采集能力是否可用？
<a class=header-anchor href=#vmagent%e8%87%aa%e5%b8%a6%e9%87%87%e9%9b%86%e8%83%bd%e5%8a%9b%e6%98%af%e5%90%a6%e5%8f%af%e7%94%a8></a></h5></li></ul><p>在实际测试过程中，启动vmagent分片加副本采集能力结合实时流聚合，资源使用大幅增加，在量级极大的情况下频繁出现采集连续断点的问题，恶化了断点导致的计算结果差异问题。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/20230330175135.png alt>
架构图参考：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%90%af%e5%8a%a8%e9%87%87%e9%9b%86%e5%8a%a0%e6%b5%81%e8%81%9a%e5%90%88%e7%9a%84%e6%9e%b6%e6%9e%84.svg alt></p><ul><li><h5 id=需计算的sample数据分别给哪个算力点计算>需计算的Sample数据分别给哪个算力点计算？
<a class=header-anchor href=#%e9%9c%80%e8%ae%a1%e7%ae%97%e7%9a%84sample%e6%95%b0%e6%8d%ae%e5%88%86%e5%88%ab%e7%bb%99%e5%93%aa%e4%b8%aa%e7%ae%97%e5%8a%9b%e7%82%b9%e8%ae%a1%e7%ae%97></a></h5></li><li><h5 id=多个算力点计算后的同维度指标集因同维度同时间窗口但不同结果值导致后到值丢弃的问题如何解决触发乱序指标处理逻辑>多个算力点计算后的同维度指标集因同维度同时间窗口但不同结果值导致后到值丢弃的问题如何解决？（触发乱序指标处理逻辑）
<a class=header-anchor href=#%e5%a4%9a%e4%b8%aa%e7%ae%97%e5%8a%9b%e7%82%b9%e8%ae%a1%e7%ae%97%e5%90%8e%e7%9a%84%e5%90%8c%e7%bb%b4%e5%ba%a6%e6%8c%87%e6%a0%87%e9%9b%86%e5%9b%a0%e5%90%8c%e7%bb%b4%e5%ba%a6%e5%90%8c%e6%97%b6%e9%97%b4%e7%aa%97%e5%8f%a3%e4%bd%86%e4%b8%8d%e5%90%8c%e7%bb%93%e6%9e%9c%e5%80%bc%e5%af%bc%e8%87%b4%e5%90%8e%e5%88%b0%e5%80%bc%e4%b8%a2%e5%bc%83%e7%9a%84%e9%97%ae%e9%a2%98%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3%e8%a7%a6%e5%8f%91%e4%b9%b1%e5%ba%8f%e6%8c%87%e6%a0%87%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91></a></h5></li></ul><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e9%97%ae%e9%a2%98.svg alt></p><ul><li><h5 id=分布式计算的资源均衡问题>分布式计算的资源均衡问题？
<a class=header-anchor href=#%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%a1%e7%ae%97%e7%9a%84%e8%b5%84%e6%ba%90%e5%9d%87%e8%a1%a1%e9%97%ae%e9%a2%98></a></h5></li><li><h5 id=插入任务id解决计算点同维度分辨问题后再次引入新维度如何解决>插入任务id解决计算点同维度分辨问题后再次引入新维度如何解决？
<a class=header-anchor href=#%e6%8f%92%e5%85%a5%e4%bb%bb%e5%8a%a1id%e8%a7%a3%e5%86%b3%e8%ae%a1%e7%ae%97%e7%82%b9%e5%90%8c%e7%bb%b4%e5%ba%a6%e5%88%86%e8%be%a8%e9%97%ae%e9%a2%98%e5%90%8e%e5%86%8d%e6%ac%a1%e5%bc%95%e5%85%a5%e6%96%b0%e7%bb%b4%e5%ba%a6%e5%a6%82%e4%bd%95%e8%a7%a3%e5%86%b3></a></h5></li></ul><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e5%a2%9e%e5%8a%a0ID.svg alt></p><h2 id=分布式流聚合的网关设计与实现>分布式流聚合的网关设计与实现
<a class=header-anchor href=#%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e7%9a%84%e7%bd%91%e5%85%b3%e8%ae%be%e8%ae%a1%e4%b8%8e%e5%ae%9e%e7%8e%b0></a></h2><p>上述章节分析了目前业界方案结合实际场景遇到的问题分析后，这一节会有针对性的对问题一一解决。
通过源码分析有两个关键部分：</p><ul><li>时间窗口的范围：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//窗口的范围是间隔设置加上间隔向右位移1位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>currentTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fasttime</span>.<span style=color:#a6e22e>UnixTimestamp</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>deleteDeadline</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>currentTime</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>intervalSecs</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>intervalSecs</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></td></tr></table></div></div><ul><li>计算窗口的逻辑：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 从缓存读取需聚合的指标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>outputKey</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>v</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalStateValue</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lastValues</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>lastValueState</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vNew</span>, <span style=color:#a6e22e>loaded</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>LoadOrStore</span>(<span style=color:#a6e22e>outputKey</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>loaded</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>vNew</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>sv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>totalStateValue</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>deleted</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>deleted</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>deleted</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从聚合后指标的缓存里面查找流入的时间线的记录值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lv</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>lastValues</span>[<span style=color:#a6e22e>inputKey</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果没有记录值，则取原始值作为记录值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lv</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>lastValueState</span>{}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>lastValues</span>[<span style=color:#a6e22e>inputKey</span>] = <span style=color:#a6e22e>lv</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>value</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果有记录值，则取新值与记录值的差值作为聚合后指标的追加值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>d</span> = <span style=color:#a6e22e>value</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>currentTime</span> &gt; <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>ignoreInputDeadline</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>deleteDeadline</span> = <span style=color:#a6e22e>deleteDeadline</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>deleteDeadline</span> = <span style=color:#a6e22e>deleteDeadline</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>从源码解读，流聚合逻辑只对时间窗口做了简易的周期判断，在流入指标因各种原因导致延迟抵达的问题导致计算值被放大没有太多逻辑处理。
这时候，我们需要一个前置模块来解决一些问题，也因vmgateway是企业组件，所以我们开发了一个属于自己的分布式流聚合的网关<code>vm-receive-route</code>。</p><h3 id=分布式流聚合网关处理的问题>分布式流聚合网关处理的问题
<a class=header-anchor href=#%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3%e5%a4%84%e7%90%86%e7%9a%84%e9%97%ae%e9%a2%98></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3base.svg alt></p><h4 id=异步>异步
<a class=header-anchor href=#%e5%bc%82%e6%ad%a5></a></h4><p>大部分的
<a href=https://prometheus.io/docs/practices/remote_write/ title="remote write项目" rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>remote write项目</code>
<i class="fa fa-external-link-alt"></i>
</a>都是同步转发的。比如
<a href=https://github.com/Telefonica/prometheus-kafka-adapter title=prometheus-kafka-adapter rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>prometheus-kafka-adapter</code>
<i class="fa fa-external-link-alt"></i>
</a>就是等<code>kafka</code>完成数据生产逻辑后才完成整个写流程，从而处理下一批<code>remote write</code>的数据。
但是流计算对数据处理是有窗口限制的，如果用同步逻辑阻塞在这里，就会影响性能，导致后续的时间<code>sample</code>会延迟，延迟错过了流计算的时间窗口的话，就会出现计算偏差。所以这里适合异步转发。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3-%e5%bc%82%e6%ad%a5%e5%86%99.svg alt></p><h4 id=时间窗口的过滤>时间窗口的过滤
<a class=header-anchor href=#%e6%97%b6%e9%97%b4%e7%aa%97%e5%8f%a3%e7%9a%84%e8%bf%87%e6%bb%a4></a></h4><p>因流聚合逻辑已经对时间线的差值做了前后大小的判断，这里就不需要引进
<a href=https://grafana.com/blog/2022/09/07/new-in-grafana-mimir-introducing-out-of-order-sample-ingestion/ title=out-of-order算法 rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>out-of-order算法</code>
<i class="fa fa-external-link-alt"></i>
</a>网关这里只需要配合流聚合逻辑的时间窗口做<code>sample</code>过滤丢弃则可。
主要解决因网络导致<code>Prometheus</code>重试发送大量积压旧<code>sample</code>影响实时值的计算结果，也解决了<code>Prometheus</code>重试大量积压<code>sample</code>引发的资源性能问题。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3-%e6%97%b6%e9%97%b4%e7%aa%97%e5%8f%a3%e8%bf%87%e6%bb%a4.svg alt></p><h4 id=维度控制>维度控制
<a class=header-anchor href=#%e7%bb%b4%e5%ba%a6%e6%8e%a7%e5%88%b6></a></h4><p>由于流聚合组件会给每条聚合后时间线插入一个节点ID来区分label。但是随着节点的横向扩容，这个label的维度也会随之增加。这里需要有一种控制维度的能力，并且能同时把时间线按维度ID来给不同的节点处理。后面我们设计了一个双重hashmod调度分配任务算法来解决这类问题。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e5%a2%9e%e5%8a%a0ID.svg alt></p><p>把标记taskid的能力前置到网关，这样就可以无视整个结构的横向扩容的节点数对任务ID维度的影响
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e5%a2%9e%e5%8a%a0ID-1.svg alt></p><h4 id=双重hashmod调度分配任务>双重hashmod调度分配任务
<a class=header-anchor href=#%e5%8f%8c%e9%87%8dhashmod%e8%b0%83%e5%ba%a6%e5%88%86%e9%85%8d%e4%bb%bb%e5%8a%a1></a></h4><p>略</p><h4 id=后端异常服务转移>后端异常服务转移
<a class=header-anchor href=#%e5%90%8e%e7%ab%af%e5%bc%82%e5%b8%b8%e6%9c%8d%e5%8a%a1%e8%bd%ac%e7%a7%bb></a></h4><p>略</p><h3 id=程序流程逻辑图>程序流程逻辑图
<a class=header-anchor href=#%e7%a8%8b%e5%ba%8f%e6%b5%81%e7%a8%8b%e9%80%bb%e8%be%91%e5%9b%be></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3-%e7%a8%8b%e5%ba%8f%e9%80%bb%e8%be%91.svg alt></p><h3 id=线上环境架构图>线上环境架构图
<a class=header-anchor href=#%e7%ba%bf%e4%b8%8a%e7%8e%af%e5%a2%83%e6%9e%b6%e6%9e%84%e5%9b%be></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%ba%bf%e4%b8%8a%e6%9e%b6%e6%9e%84%e5%9b%be.svg alt></p><h2 id=record-rule维度任务生成器>Record Rule维度任务生成器
<a class=header-anchor href=#record-rule%e7%bb%b4%e5%ba%a6%e4%bb%bb%e5%8a%a1%e7%94%9f%e6%88%90%e5%99%a8></a></h2><p>流聚合计算是一种实时处理和分析大量数据流的技术。其主要目的是从高速、连续不断的数据流中提取有价值的信息，例如：计算平均值、求和、最大值、最小值等。流聚合计算通常会在内存中进行，以保持较低的延迟和高吞吐量。</p><p>流聚合计算的实现通常包含以下几个关键部分：</p><ol><li>数据源和数据接收器：设定和监控数据流，如：日志、网络数据包、传感器数据等，将数据流分为多个小批次。</li><li>窗口操作：数据流会被分成一系列固定或滑动窗口。每个窗口内的数据会进行预先定义的聚合操作。</li><li>聚合函数：对窗口内的数据进行各种操作,例如：计数、求和、均值、最大/最小值等。</li><li>输出：将聚合结果输出或存储，以备进一步处理或实时数据可视化。</li></ol><p>在指标流聚合中，该能力是对单一指标做高效的降维计算，但是在现实中要描述复杂场景是需要对多指标来结合函数计算的。</p><p>流聚合可以高效解决以下聚合过滤<code>req_path</code>的字段</p><ul><li>聚合前：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_port=</span><span style=color:#f92672>&#34;30021&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;202&#34;</span>,<span style=color:#960050;background-color:#1e0010>req_path=</span><span style=color:#f92672>&#34;/xxxx/yyyy?abc=exg&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_port=</span><span style=color:#f92672>&#34;30023&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;202&#34;</span>,<span style=color:#960050;background-color:#1e0010>req_path=</span><span style=color:#f92672>&#34;/xxxx/yyyy?abc=sdf&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_port=</span><span style=color:#f92672>&#34;10021&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;202&#34;</span>,<span style=color:#960050;background-color:#1e0010>req_path=</span><span style=color:#f92672>&#34;/xxxx/yyyy?abc=fasdfa&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_port=</span><span style=color:#f92672>&#34;20210&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;202&#34;</span>,<span style=color:#960050;background-color:#1e0010>req_path=</span><span style=color:#f92672>&#34;/xxxx/yyyy?abc=asdfe&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_port=</span><span style=color:#f92672>&#34;20211&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;202&#34;</span>,<span style=color:#960050;background-color:#1e0010>req_path=</span><span style=color:#f92672>&#34;/xxxx/yyyy?abc=sfadsf&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_port=</span><span style=color:#f92672>&#34;21210&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;500&#34;</span>,<span style=color:#960050;background-color:#1e0010>req_path=</span><span style=color:#f92672>&#34;/xxxx/yyyy?abc=caresaf&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_port=</span><span style=color:#f92672>&#34;30121&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;400&#34;</span>,<span style=color:#960050;background-color:#1e0010>req_path=</span><span style=color:#f92672>&#34;/xxxx/yyyy?abc=werads&#34;</span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>聚合后：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>agg_a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;202&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>agg_a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;500&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>agg_a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>zone=</span><span style=color:#f92672>&#34;bj&#34;</span>,<span style=color:#960050;background-color:#1e0010>src_svr=</span><span style=color:#f92672>&#34;192.168.1.2&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_svr=</span><span style=color:#f92672>&#34;192.168.2.3&#34;</span>,<span style=color:#960050;background-color:#1e0010>dis_port=</span><span style=color:#f92672>&#34;8080&#34;</span>,<span style=color:#960050;background-color:#1e0010>code=</span><span style=color:#f92672>&#34;400&#34;</span>}
</span></span></code></pre></td></tr></table></div></div><p>但是我们最终要做展示的是某个目标地址的成功率：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>sum</span> <span style=color:#960050;background-color:#1e0010>by</span> <span style=color:#960050;background-color:#1e0010>(dis_svr)</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>(</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>rate(a_http_req_total</span>{<span style=color:#960050;background-color:#1e0010>code=~</span><span style=color:#f92672>&#34;2.*&#34;</span>}[<span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>m</span>]<span style=color:#960050;background-color:#1e0010>)</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>)</span> 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>/</span> 
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>sum</span> <span style=color:#960050;background-color:#1e0010>by</span> <span style=color:#960050;background-color:#1e0010>(dis_svr)</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>(</span>
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>rate(a_http_req_total</span>{}[<span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>m</span>]<span style=color:#960050;background-color:#1e0010>)</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>)</span> 
</span></span></code></pre></td></tr></table></div></div><p>我们可以利用<code>Prometheus</code>的<code>Record Rule</code>来直接算聚合场景指标。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span>groups:
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (src_svr,dis_svr,code)
</span></span><span style=display:flex><span>			  (
</span></span><span style=display:flex><span>				  rate(a_http_req_total<span style=color:#960050;background-color:#1e0010>{}</span>[<span style=color:#ae81ff>5</span>m])
</span></span><span style=display:flex><span>			  )
</span></span><span style=display:flex><span>	record: a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span></code></pre></td></tr></table></div></div><p>但是<code>Record Rule</code>会把指标<code>a_http_req_total</code>的所有维度数据加载到内存，如果维度达到临界值就会触发内存OOM。即使没有达到临界值，该计算量也会随着维度增加以致计算结果点被延迟。
在实际生产环境中，<code>istio_request_total</code>的qps数据会延迟20分钟之久。
在结合流聚合计算把维度降低，使时间线从千万级别降低到万级别，也只是从20分钟的延迟降低到1-2分钟。
流聚合后的<code>Record Rule</code>的配置：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span>groups:
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (src_svr,dis_svr,code)
</span></span><span style=display:flex><span>			  (
</span></span><span style=display:flex><span>				  rate(agg_a_http_req_total<span style=color:#960050;background-color:#1e0010>{}</span>[<span style=color:#ae81ff>5</span>m])
</span></span><span style=display:flex><span>			  )
</span></span><span style=display:flex><span>	record: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span></code></pre></td></tr></table></div></div><p>通过分析<code>Rule</code>模块的源码，我们可以做更细化的配置能力：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span>groups:
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>xx
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (src_svr,dis_svr,code)
</span></span><span style=display:flex><span>			  (
</span></span><span style=display:flex><span>				  rate(agg_a_http_req_total<span style=color:#960050;background-color:#1e0010>{</span>code<span style=color:#f92672>=~</span><span style=color:#e6db74>&#34;2.**&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>[<span style=color:#ae81ff>5</span>m])
</span></span><span style=display:flex><span>			  )
</span></span><span style=display:flex><span>	record: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m<span style=color:#f92672>-</span><span style=color:#ae81ff>4</span>xx
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (src_svr,dis_svr,code)
</span></span><span style=display:flex><span>			  (
</span></span><span style=display:flex><span>				  rate(agg_a_http_req_total<span style=color:#960050;background-color:#1e0010>{</span>code<span style=color:#f92672>=~</span><span style=color:#e6db74>&#34;4.**&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>[<span style=color:#ae81ff>5</span>m])
</span></span><span style=display:flex><span>			  )
</span></span><span style=display:flex><span>	record: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m<span style=color:#f92672>-</span><span style=color:#ae81ff>5</span>xx
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (src_svr,dis_svr,code)
</span></span><span style=display:flex><span>			  (
</span></span><span style=display:flex><span>				  rate(agg_a_http_req_total<span style=color:#960050;background-color:#1e0010>{</span>code<span style=color:#f92672>=~</span><span style=color:#e6db74>&#34;5.**&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>[<span style=color:#ae81ff>5</span>m])
</span></span><span style=display:flex><span>			  )
</span></span><span style=display:flex><span>	record: agg_a_http_req_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span></code></pre></td></tr></table></div></div><p>这样我们就可以通过对某个维度标签拆分的查询，以达到生成同样的新指标并发处理能力。</p><p>问题是，生产的维度标签大多数是动态变化的，我们怎么去动态生成这种按维度标签拆分的查询来实现并发<code>Record Rule</code>呢？我们需要一个对标签元数据的管理系统来对标签维度元数据进行跟踪和管理。
这时候我们实现了一个小型的元数据<code>watch模块</code>和<code>rule build模块</code>来解决该问题。
该组件<code>ruler-handle-process</code>的配置是这样子的：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span>recode_rules:
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> interval: <span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span>  recode_to: istio_requests_total:sum:rate:<span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span>  metric_name: istio_requests_total
</span></span><span style=display:flex><span>  aggr_type: sum
</span></span><span style=display:flex><span>  vector_type: rate
</span></span><span style=display:flex><span>  vector_range: <span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span>  group_by_and_filter:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> source_workload
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> destination_workload
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> cluster
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> namespace
</span></span><span style=display:flex><span>  group_by:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> response_code
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> namespace
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> source_workload_namespace
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> destination_workload_namespace
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> destination_service_name
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> cluster
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> reporter
</span></span><span style=display:flex><span>  filter_by:
</span></span><span style=display:flex><span>    cluster: <span style=color:#e6db74>&#34;k8s-hw-bj-xxxxxx&#34;</span>
</span></span><span style=display:flex><span>  with_out:
</span></span><span style=display:flex><span>    source_workload: <span style=color:#e6db74>&#34;ingressgateway-workflows&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>ruler-handle-process</code>就会<code>watch</code>指标名<code>"istio_requests_total"</code>下的<code>response_code</code>、<code>namespace</code>、<code>source_workload_namespace</code>、<code>destination_workload_namespace</code>、<code>destination_service_name</code>、<code>cluster</code>、<code>reporter</code>的维度组合来生成一堆<code>Record Rule</code>规则。
结合Rule组件来实现并发计算，我们就可以把计算延迟缩短到秒级完成。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span>groups:
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: istio_requests_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m<span style=color:#f92672>-</span><span style=color:#ae81ff>7218756</span>fe8a0bc327e818812cefb02f7
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (request_protocol, grpc_response_status, response_code, svr_response_code,
</span></span><span style=display:flex><span>      namespace, source_workload_namespace, destination_workload_namespace, destination_service_name,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>cluster</span>, reporter, source_workload, destination_workload, <span style=color:#66d9ef>cluster</span>, namespace)
</span></span><span style=display:flex><span>      (rate(istio_requests_total<span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>cluster</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;k8s-hw-bj-1-prod&#34;</span>,destination_workload<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;skyaxe-778-flink&#34;</span>,namespace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;istio-ingress&#34;</span>,source_workload<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;ingressgateway-streaming&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>[<span style=color:#ae81ff>5</span>m]))
</span></span><span style=display:flex><span>    record: istio_requests_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: istio_requests_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m<span style=color:#f92672>-</span><span style=color:#ae81ff>8</span>e30244048f8d5519a6332f309578ed4
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (request_protocol, grpc_response_status, response_code, svr_response_code,
</span></span><span style=display:flex><span>      namespace, source_workload_namespace, destination_workload_namespace, destination_service_name,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>cluster</span>, reporter, source_workload, destination_workload, <span style=color:#66d9ef>cluster</span>, namespace)
</span></span><span style=display:flex><span>      (rate(istio_requests_total<span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>cluster</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;k8s-hw-bj-1-prod&#34;</span>,destination_workload<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;t-bean-portal&#34;</span>,namespace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;coin&#34;</span>,source_workload<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;unknown&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>[<span style=color:#ae81ff>5</span>m]))
</span></span><span style=display:flex><span>    record: istio_requests_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> name: istio_requests_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m<span style=color:#f92672>-</span>ea2d81ce1c35a7ba5a72b9e23fe7faf6
</span></span><span style=display:flex><span>  rules:
</span></span><span style=display:flex><span>  <span style=color:#f92672>-</span> expr: <span style=color:#66d9ef>sum</span> <span style=color:#66d9ef>by</span> (request_protocol, grpc_response_status, response_code, svr_response_code,
</span></span><span style=display:flex><span>      namespace, source_workload_namespace, destination_workload_namespace, destination_service_name,
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>cluster</span>, reporter, source_workload, destination_workload, <span style=color:#66d9ef>cluster</span>, namespace)
</span></span><span style=display:flex><span>      (rate(istio_requests_total<span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>cluster</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;k8s-hw-bj-1-prod&#34;</span>,destination_workload<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wefly-ad-report&#34;</span>,namespace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wf&#34;</span>,source_workload<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;wefly-app-packages&#34;</span><span style=color:#960050;background-color:#1e0010>}</span>[<span style=color:#ae81ff>5</span>m]))
</span></span><span style=display:flex><span>    record: istio_requests_total:<span style=color:#66d9ef>sum</span>:rate:<span style=color:#ae81ff>5</span>m
</span></span></code></pre></td></tr></table></div></div><h2 id=指标流聚合在监控平台的架构组合>指标流聚合在监控平台的架构组合
<a class=header-anchor href=#%e6%8c%87%e6%a0%87%e6%b5%81%e8%81%9a%e5%90%88%e5%9c%a8%e7%9b%91%e6%8e%a7%e5%b9%b3%e5%8f%b0%e7%9a%84%e6%9e%b6%e6%9e%84%e7%bb%84%e5%90%88></a></h2><p>在我们利用社区开源程序和我们的自研组件，在不同采集量场景下可以做不同的组合来解决不同量级的高维度数据。</p><h3 id=万级别单一指标的流聚合>万级别单一指标的流聚合
<a class=header-anchor href=#%e4%b8%87%e7%ba%a7%e5%88%ab%e5%8d%95%e4%b8%80%e6%8c%87%e6%a0%87%e7%9a%84%e6%b5%81%e8%81%9a%e5%90%88></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%ba%bf%e4%b8%8a%e6%9e%b6%e6%9e%84%e5%9b%be-%e5%8d%95VM.svg alt></p><h3 id=万级别多指标的计算聚合>万级别多指标的计算聚合
<a class=header-anchor href=#%e4%b8%87%e7%ba%a7%e5%88%ab%e5%a4%9a%e6%8c%87%e6%a0%87%e7%9a%84%e8%ae%a1%e7%ae%97%e8%81%9a%e5%90%88></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/rule%e8%81%9a%e5%90%88%e7%ba%bf%e4%b8%8a%e6%9e%b6%e6%9e%84%e5%9b%be-%e5%8d%95VM.svg alt></p><h3 id=百万级别以上的单一指标流聚合>百万级别以上的单一指标流聚合
<a class=header-anchor href=#%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e4%bb%a5%e4%b8%8a%e7%9a%84%e5%8d%95%e4%b8%80%e6%8c%87%e6%a0%87%e6%b5%81%e8%81%9a%e5%90%88></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%ba%bf%e4%b8%8a%e6%9e%b6%e6%9e%84%e5%9b%be.svg alt></p><h3 id=百万级别以上的指标对场景的计算聚合>百万级别以上的指标对场景的计算聚合
<a class=header-anchor href=#%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e4%bb%a5%e4%b8%8a%e7%9a%84%e6%8c%87%e6%a0%87%e5%af%b9%e5%9c%ba%e6%99%af%e7%9a%84%e8%ae%a1%e7%ae%97%e8%81%9a%e5%90%88></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e7%99%be%e4%b8%87%e7%ba%a7%e5%88%ab%e4%bb%a5%e4%b8%8a%e7%9a%84%e6%8c%87%e6%a0%87%e5%af%b9%e5%9c%ba%e6%99%af%e7%9a%84%e8%ae%a1%e7%ae%97%e8%81%9a%e5%90%88.svg alt></p></div><footer class=post-footer><div class=post-tags><a href=/tags/prometheus>Prometheus
</a><a href=/tags/victoriametrics>VictoriaMetrics</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="蓝宝石的傻话 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="蓝宝石的傻话 - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
VictoriaMetrics的指标流聚合能力应用</li><li class=post-copyright-author><strong>本文作者： </strong>蓝宝石的傻话</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/posts/opentelemetry/stream-metrics-one/ title=VictoriaMetrics的指标流聚合能力应用>/posts/opentelemetry/stream-metrics-one/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/ebpf/deepflow-agent-proto-dev/ rel=next title="eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）"><i class="fa fa-chevron-left"></i> eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/ebpf/pixie-try/ rel=prev title=eBPF系列之：Pixie浅剖析>eBPF系列之：Pixie浅剖析
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>蓝宝石的傻话</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.139.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备2023145803号</a>
<img src=/imgs/gongan.png alt=粤公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011102001194" target=_blank>粤公网安备 44011102001194 号</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>