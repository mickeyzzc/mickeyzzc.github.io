<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.121.1"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.png><meta itemprop=name content="指标流聚合系列二：分布式流聚合的网关设计与实现"><meta itemprop=description content="What is rational is real; and what is real is rational."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/icons/custom.png"><meta itemprop=keywords content="Prometheus,VictoriaMetrics"><meta property="og:type" content="article"><meta property="og:title" content="指标流聚合系列二：分布式流聚合的网关设计与实现"><meta property="og:description" content="What is rational is real; and what is real is rational."><meta property="og:image" content="/imgs/icons/custom.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/posts/opentelemetry/stream-metrics-two/"><meta property="og:site_name" content="蓝宝石的傻话"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="蓝宝石的傻话"><meta property="article:published_time" content="2023-03-28 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2023-03-28 00:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.374a99719ba5f425af97e9e4d4b002d4efa1a29ac3be3b0cb855d613bc1fbddf.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"stream-metrics-two","permalink":"/posts/opentelemetry/stream-metrics-two/","title":"指标流聚合系列二：分布式流聚合的网关设计与实现","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>指标流聚合系列二：分布式流聚合的网关设计与实现 - 蓝宝石的傻话</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>蓝宝石的傻话</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>MickeyBee's BLOG</p><img class=custom-logo-image src=/imgs/icons/custom.png alt=蓝宝石的傻话></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>13</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#分布式流聚合网关处理的问题>分布式流聚合网关处理的问题</a><ul><li><a href=#1异步>1、异步</a></li><li><a href=#2时间窗口的过滤>2、时间窗口的过滤</a></li><li><a href=#3维度控制>3、维度控制</a></li><li><a href=#4双重hashmod调度分配任务>4、双重hashmod调度分配任务</a></li><li><a href=#5后端异常服务转移>5、后端异常服务转移</a></li></ul></li><li><a href=#程序流程逻辑图>程序流程逻辑图</a></li><li><a href=#线上环境架构图>线上环境架构图</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=蓝宝石的傻话 src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpeg><p class=site-author-name itemprop=name>蓝宝石的傻话</p><div class=site-description itemprop=description>What is rational is real; and what is real is rational.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>10</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/mickeyzzc title="Github → https://github.com/mickeyzzc" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=https://gitee.com/mickeybee title="Gitee → https://gitee.com/mickeybee" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Gitee
</a></span><span class=links-of-social-item><a href=mailto:mickey_zzc@163.com title="E-Mail → mailto:mickey_zzc@163.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://deepflow.io/ title=https://deepflow.io/ target=_blank>DeepFlow</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2016-08-11T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=27444></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=60></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-11-25T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/mickeyzzc rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/stream-metrics-two/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="指标流聚合系列二：分布式流聚合的网关设计与实现"><meta itemprop=description content="通过《指标流聚合系列一：社区VM对指标流聚合能力分析与问题》分析了目前业界方案结合实际场景遇到的问题分析后，这一节会有针对性的对问题一一解决"></span><header class=post-header><h1 class=post-title itemprop="name headline">指标流聚合系列二：分布式流聚合的网关设计与实现
<a href=https://github.com/mickeyzzc/mickeyzzcblog/tree/main/content/posts/opentelemetry/stream-metrics-two.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-03-28 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-03-28 00:00:00 +0000 UTC">2023-03-28
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/victoriametrics itemprop=url rel=index><span itemprop=name>Prometheus/VictoriaMetrics</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>1068</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>3分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/posts/opentelemetry/stream-metrics-two/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p>通过《指标流聚合系列一：社区VM对指标流聚合能力分析与问题》分析了目前业界方案结合实际场景遇到的问题分析后，这一节会有针对性的对问题一一解决。
通过源码分析有两个关键部分：</p><ul><li>时间窗口的范围：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>//窗口的范围是间隔设置加上间隔向右位移1位
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>currentTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fasttime</span>.<span style=color:#a6e22e>UnixTimestamp</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>deleteDeadline</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>currentTime</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>intervalSecs</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>intervalSecs</span> <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>)
</span></span></code></pre></td></tr></table></div></div><ul><li>计算窗口的逻辑：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 从缓存读取需聚合的指标
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>v</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Load</span>(<span style=color:#a6e22e>outputKey</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>v</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>totalStateValue</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>lastValues</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>lastValueState</span>),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>vNew</span>, <span style=color:#a6e22e>loaded</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>LoadOrStore</span>(<span style=color:#a6e22e>outputKey</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>loaded</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>v</span> = <span style=color:#a6e22e>vNew</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>sv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>v</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>totalStateValue</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>deleted</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>deleted</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>deleted</span> {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 从聚合后指标的缓存里面查找流入的时间线的记录值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>lv</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>lastValues</span>[<span style=color:#a6e22e>inputKey</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果没有记录值，则取原始值作为记录值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>lv</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>lastValueState</span>{}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>lastValues</span>[<span style=color:#a6e22e>inputKey</span>] = <span style=color:#a6e22e>lv</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>value</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// 如果有记录值，则取新值与记录值的差值作为聚合后指标的追加值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#a6e22e>d</span> = <span style=color:#a6e22e>value</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>currentTime</span> &gt; <span style=color:#a6e22e>as</span>.<span style=color:#a6e22e>ignoreInputDeadline</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>d</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>value</span> = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>lv</span>.<span style=color:#a6e22e>deleteDeadline</span> = <span style=color:#a6e22e>deleteDeadline</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sv</span>.<span style=color:#a6e22e>deleteDeadline</span> = <span style=color:#a6e22e>deleteDeadline</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>从源码解读，流聚合逻辑只对时间窗口做了简易的周期判断，在流入指标因各种原因导致延迟抵达的问题导致计算值被放大没有太多逻辑处理。
这时候，我们需要一个前置模块来解决一些问题，也因vmgateway是企业组件，所以我们开发了一个属于自己的分布式流聚合的网关<code>vm-receive-route</code>。</p><h2 id=分布式流聚合网关处理的问题>分布式流聚合网关处理的问题
<a class=header-anchor href=#%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3%e5%a4%84%e7%90%86%e7%9a%84%e9%97%ae%e9%a2%98></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3base.svg alt></p><h3 id=1异步>1、异步
<a class=header-anchor href=#1%e5%bc%82%e6%ad%a5></a></h3><p>大部分的
<a href=https://prometheus.io/docs/practices/remote_write/ title="<code>remote write项目</code>" rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>remote write项目</code>
<i class="fa fa-external-link-alt"></i>
</a>都是同步转发的。比如
<a href=https://github.com/Telefonica/prometheus-kafka-adapter title="<code>prometheus-kafka-adapter</code>" rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>prometheus-kafka-adapter</code>
<i class="fa fa-external-link-alt"></i>
</a>就是等<code>kafka</code>完成数据生产逻辑后才完成整个写流程，从而处理下一批<code>remote write</code>的数据。
但是流计算对数据处理是有窗口限制的，如果用同步逻辑阻塞在这里，就会影响性能，导致后续的时间<code>sample</code>会延迟，延迟错过了流计算的时间窗口的话，就会出现计算偏差。所以这里适合异步转发。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3-%e5%bc%82%e6%ad%a5%e5%86%99.svg alt></p><h3 id=2时间窗口的过滤>2、时间窗口的过滤
<a class=header-anchor href=#2%e6%97%b6%e9%97%b4%e7%aa%97%e5%8f%a3%e7%9a%84%e8%bf%87%e6%bb%a4></a></h3><p>因流聚合逻辑已经对时间线的差值做了前后大小的判断，这里就不需要引进
<a href=https://grafana.com/blog/2022/09/07/new-in-grafana-mimir-introducing-out-of-order-sample-ingestion/ title="<code>out-of-order算法</code>" rel="noopener external nofollow noreferrer" target=_blank class=exturl><code>out-of-order算法</code>
<i class="fa fa-external-link-alt"></i>
</a>网关这里只需要配合流聚合逻辑的时间窗口做<code>sample</code>过滤丢弃则可。
主要解决因网络导致<code>Prometheus</code>重试发送大量积压旧<code>sample</code>影响实时值的计算结果，也解决了<code>Prometheus</code>重试大量积压<code>sample</code>引发的资源性能问题。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3-%e6%97%b6%e9%97%b4%e7%aa%97%e5%8f%a3%e8%bf%87%e6%bb%a4.svg alt></p><h3 id=3维度控制>3、维度控制
<a class=header-anchor href=#3%e7%bb%b4%e5%ba%a6%e6%8e%a7%e5%88%b6></a></h3><p>由于流聚合组件会给每条聚合后时间线插入一个节点ID来区分label。但是随着节点的横向扩容，这个label的维度也会随之增加。这里需要有一种控制维度的能力，并且能同时把时间线按维度ID来给不同的节点处理。后面我们设计了一个双重hashmod调度分配任务算法来解决这类问题。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e5%a2%9e%e5%8a%a0ID.svg alt></p><p>把标记taskid的能力前置到网关，这样就可以无视整个结构的横向扩容的节点数对任务ID维度的影响
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e5%88%86%e5%b8%83%e5%bc%8f%e6%b5%81%e8%81%9a%e5%90%88%e5%a2%9e%e5%8a%a0ID-1.svg alt></p><h3 id=4双重hashmod调度分配任务>4、双重hashmod调度分配任务
<a class=header-anchor href=#4%e5%8f%8c%e9%87%8dhashmod%e8%b0%83%e5%ba%a6%e5%88%86%e9%85%8d%e4%bb%bb%e5%8a%a1></a></h3><p>略</p><h3 id=5后端异常服务转移>5、后端异常服务转移
<a class=header-anchor href=#5%e5%90%8e%e7%ab%af%e5%bc%82%e5%b8%b8%e6%9c%8d%e5%8a%a1%e8%bd%ac%e7%a7%bb></a></h3><p>略</p><h2 id=程序流程逻辑图>程序流程逻辑图
<a class=header-anchor href=#%e7%a8%8b%e5%ba%8f%e6%b5%81%e7%a8%8b%e9%80%bb%e8%be%91%e5%9b%be></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%bd%91%e5%85%b3-%e7%a8%8b%e5%ba%8f%e9%80%bb%e8%be%91.svg alt></p><h2 id=线上环境架构图>线上环境架构图
<a class=header-anchor href=#%e7%ba%bf%e4%b8%8a%e7%8e%af%e5%a2%83%e6%9e%b6%e6%9e%84%e5%9b%be></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/%e6%b5%81%e8%81%9a%e5%90%88%e7%ba%bf%e4%b8%8a%e6%9e%b6%e6%9e%84%e5%9b%be.svg alt></p></div><footer class=post-footer><div class=post-tags><a href=/tags/prometheus>Prometheus
</a><a href=/tags/victoriametrics>VictoriaMetrics</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="蓝宝石的傻话 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="蓝宝石的傻话 - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
指标流聚合系列二：分布式流聚合的网关设计与实现</li><li class=post-copyright-author><strong>本文作者： </strong>蓝宝石的傻话</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/posts/opentelemetry/stream-metrics-two/ title=指标流聚合系列二：分布式流聚合的网关设计与实现>/posts/opentelemetry/stream-metrics-two/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/opentelemetry/stream-metrics-three/ rel=next title="指标流聚合系列三：Record Rule维度任务生成器"><i class="fa fa-chevron-left"></i> 指标流聚合系列三：Record Rule维度任务生成器</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/opentelemetry/stream-metrics-one/ rel=prev title=指标流聚合系列一：社区VM对指标流聚合能力分析与问题>指标流聚合系列一：社区VM对指标流聚合能力分析与问题
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>蓝宝石的傻话</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.121.1 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备2023145803号</a>
<img src=/imgs/gongan.png alt=粤公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011102001194" target=_blank>粤公网安备 44011102001194 号</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>