<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.139.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.png><meta itemprop=name content="监控系统企业架构演进史-初入Prometheus"><meta itemprop=description content="What is rational is real; and what is real is rational."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/icons/custom.png"><meta itemprop=keywords content="MickeyBee,MickeyZZC,可观测性,Sre,运维,eBPF"><meta property="og:type" content="article"><meta property="og:title" content="监控系统企业架构演进史-初入Prometheus"><meta property="og:description" content="What is rational is real; and what is real is rational."><meta property="og:image" content="/imgs/icons/custom.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/posts/opentelemetry/prometheus-evolution-history-one/"><meta property="og:site_name" content="蓝宝石的傻话"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="蓝宝石的傻话"><meta property="article:published_time" content="2019-12-12 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2019-12-12 00:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.374a99719ba5f425af97e9e4d4b002d4efa1a29ac3be3b0cb855d613bc1fbddf.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"prometheus-evolution-history-one","permalink":"/posts/opentelemetry/prometheus-evolution-history-one/","title":"监控系统企业架构演进史-初入Prometheus","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>监控系统企业架构演进史-初入Prometheus - 蓝宝石的傻话</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>蓝宝石的傻话</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>MickeyBee's BLOG</p><img class=custom-logo-image src=/imgs/icons/custom.png alt=蓝宝石的傻话></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>14</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#单节点架构>单节点架构</a><ul><li><a href=#指标数据采集>指标数据采集</a><ul><li></li></ul></li><li><a href=#告警配置>告警配置</a></li><li><a href=#告警内部逻辑>告警内部逻辑</a></li></ul></li><li><a href=#联邦部署>联邦部署</a></li><li><a href=#分布式架构雏型>分布式架构雏型</a><ul><li><a href=#数据处理逻辑架构>数据处理逻辑架构</a></li><li><a href=#数据查询逻辑架构>数据查询逻辑架构</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=蓝宝石的傻话 src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpeg><p class=site-author-name itemprop=name>蓝宝石的傻话</p><div class=site-description itemprop=description>What is rational is real; and what is real is rational.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>14</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>10</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/mickeyzzc title="Github → https://github.com/mickeyzzc" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=https://gitee.com/mickeybee title="Gitee → https://gitee.com/mickeybee" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Gitee
</a></span><span class=links-of-social-item><a href=mailto:mickey_zzc@163.com title="E-Mail → mailto:mickey_zzc@163.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://blog.51cto.com/mickeyzzc title=https://blog.51cto.com/mickeyzzc target=_blank>我的51cto博客</a></li><li class=links-of-blogroll-item><a href=https://deepflow.io/ title=https://deepflow.io/ target=_blank>DeepFlow</a></li><li class=links-of-blogroll-item><a href=https://blog.csdn.net/mickey_zzc title=https://blog.csdn.net/mickey_zzc target=_blank>CSDN博客</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2016-08-11T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=31194></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=68></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-11-25T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/mickeyzzc rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/prometheus-evolution-history-one/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="监控系统企业架构演进史-初入Prometheus"><meta itemprop=description content="Prometheus是一个开源的监控与时间序列数据库系统,在近年来得到了越来越广泛的应用。
官方的架构图如图所示：

本系列文章会以Prometheus的在一个企业里的部署架构演进过程中逐步理解和深入各种组件和概念。
先通过下图简单了解这个演进发展史
"></span><header class=post-header><h1 class=post-title itemprop="name headline">监控系统企业架构演进史-初入Prometheus
<a href=https://github.com/mickeyzzc/mickeyzzcblog/tree/main/content/posts/opentelemetry/prometheus-evolution-history-one.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2019-12-12 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2019-12-12 00:00:00 +0000 UTC">2019-12-12</time></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>3307</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>7分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/posts/opentelemetry/prometheus-evolution-history-one/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p><code>Prometheus</code>是一个开源的监控与时间序列数据库系统,在近年来得到了越来越广泛的应用。
官方的架构图如图所示：
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/prometheus-architecture.svg alt>
本系列文章会以<code>Prometheus</code>的在一个企业里的部署架构演进过程中逐步理解和深入各种组件和概念。
先通过下图简单了解这个演进发展史
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/monitoring-system-2019-2020.png alt></p><h2 id=单节点架构>单节点架构
<a class=header-anchor href=#%e5%8d%95%e8%8a%82%e7%82%b9%e6%9e%b6%e6%9e%84></a></h2><p>刚开始接触<code>Prometheus</code>监控体系，只需要在服务端部署<code>Prometheus</code>的二进制文件，用最基础的文件服务发现配置<code>file_sd_config</code>来实现对主机基础监控<code>node_exporter</code>进行拉取指标采集即可。
再通过<code>Grafana</code>的<code>datasource</code>配置<code>Prometheus</code>的<code>url</code>地址即可开始配置查看监控数据。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/Prometheus-simple.svg alt></p><h3 id=指标数据采集>指标数据采集
<a class=header-anchor href=#%e6%8c%87%e6%a0%87%e6%95%b0%e6%8d%ae%e9%87%87%e9%9b%86></a></h3><p>Prometheus的数据模型主要由Metric、Label和 Sample组成。</p><h5 id=metric>Metric:
<a class=header-anchor href=#metric></a></h5><ul><li>表示一个时序指标,对应于一个监控指标名称。如cpu_usage、free_memory等。</li><li>Metric仅包含时序数据名称,没有预定义的结构或类型。这使Prometheus具有很高的灵活性。</li><li>一个Prometheus实例可以包含任意数量的Metric。</li></ul><h5 id=label>Label:
<a class=header-anchor href=#label></a></h5><ul><li>用来描述和区分相同Metric的数据。类似于其他时序数据库的Tag。</li><li>Label通常表示数据的维度或属性,如instance、job、region等。</li><li>每个样本数据都必须包含相同的Label集。Label用于快速查询和聚合特定维度的数据。</li><li>Label的值可以是字符串、布尔值或整数。支持在Label上过滤和分组数据。</li></ul><h5 id=sample>Sample:
<a class=header-anchor href=#sample></a></h5><ul><li>表示一条时序数据,包含Timestamp、Value和Label集。</li><li>Timestamp表示时序数据的时间戳,精度为毫秒。它用于排序和查询给定时间范围的数据。</li><li>Value表示时序指标的值,可以是浮点数、整数或字符串。</li><li>Label集用于标识该Sample数据的属性与维度。相同Label的Sample表示同一指标的不同记录。</li></ul><p>一个Prometheus Sample包含:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span>Metric <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>时序指标名称</span> 
</span></span><span style=display:flex><span>Timestamp <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>时间戳</span>,<span style=color:#960050;background-color:#1e0010>毫秒精度</span> 
</span></span><span style=display:flex><span>Value <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>指标数值</span> 
</span></span><span style=display:flex><span>Label <span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>数据属性集</span>
</span></span></code></pre></td></tr></table></div></div><p>例如:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>###################################################
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Metric: cpu_usage
</span></span><span style=display:flex><span>Timestamp: <span style=color:#ae81ff>1577836800000</span> 
</span></span><span style=display:flex><span>Value: <span style=color:#ae81ff>0.6</span>
</span></span><span style=display:flex><span>Label: instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;web01&#34;</span>, job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webapp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###################################################
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>Metric: free_memory 
</span></span><span style=display:flex><span>Timestamp: <span style=color:#ae81ff>1577836800000</span>
</span></span><span style=display:flex><span>Value: <span style=color:#ae81ff>20</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1024</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1024</span> 
</span></span><span style=display:flex><span>Label: instance<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;web01&#34;</span>, job<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;webapp&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>###################################################
</span></span></span></code></pre></td></tr></table></div></div><p>如下所示是采集到的数据结构样例</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/Prometheus-porc.jpeg alt></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e># HELP thanos_grpc_req_panics_recovered_total Total number of gRPC requests recovered from internal panic.
</span></span></span><span style=display:flex><span><span style=color:#75715e># TYPE thanos_grpc_req_panics_recovered_total counter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>thanos_grpc_req_panics_recovered_total <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># HELP thanos_objstore_bucket_last_successful_upload_time Second timestamp of the last successful upload to the bucket.
</span></span></span><span style=display:flex><span><span style=color:#75715e># TYPE thanos_objstore_bucket_last_successful_upload_time gauge
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>thanos_objstore_bucket_last_successful_upload_time{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>} <span style=color:#ae81ff>1.591146025002795e+09</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># HELP thanos_objstore_bucket_operation_duration_seconds Duration of successful operations against the bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e># TYPE thanos_objstore_bucket_operation_duration_seconds histogram
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.001&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.01&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.1&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.3&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.6&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;1&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;3&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;6&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;9&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;20&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;30&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;60&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;90&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;120&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_bucket{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>,le<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;+Inf&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_sum{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>thanos_objstore_bucket_operation_duration_seconds_count{bucket<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;thanos&#34;</span>,operation<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;delete&#34;</span>} <span style=color:#ae81ff>0</span>
</span></span></code></pre></td></tr></table></div></div><p>Prometheus中定义了四种主要的指标类型:</p><ol><li>Gauge(仪表盘) 适用于可任意变化的指标,如温度,pressure。</li><li>Counter(计数器) 只能单调递增的指标,适合记录如请求数,任务完成数,错误数等。</li><li>Histogram(直方图) 一般用来记录请求持续时间,响应大小等指标。它通过配置桶来记录Value分布情况。可以用来计算分位值,平均值等。</li><li>Summary 和Histogram类似,直接存储了分位值,可以更方便的计算分位值。</li></ol><p>这四种指标类型可以表示不同类型的指标:</p><ul><li>Gauge:瞬时值</li><li>Counter:计数总量</li><li>Histogram/Summary:统计分布</li></ul><p>根据需要的监控指标类型选择合适的类型。Prometheus在抓取和存储样本时,会根据类型做不同的处理。我们看一下以下案例。</p><h3 id=告警配置>告警配置
<a class=header-anchor href=#%e5%91%8a%e8%ad%a6%e9%85%8d%e7%bd%ae></a></h3><p>当需要告警的时候，就要部署<code>Alertmanager</code>组件，并且开始在<code>Prometheus</code>配置<code>Alertmanager</code>的信息，告警规则需要在<code>Prometheus</code>配置以进行周期性计算，把达到阈值的告警信息发送给<code>Alertmanager</code>组件来做处理。</p><blockquote><p>关于<code>Prometheus</code>的告警机制,以及它和<code>Alertmanager</code>的关系,以下简要说明:</p><ul><li><code>Prometheus</code>告警规则
<code>Prometheus</code>服务器中定义了告警规则(<code>rules</code>),它根据<code>PromQL</code>指定的表达式判断是否要生成告警。一旦表达式输出结果为<code>true</code>,则会创建一个告警事件。</li><li><code>Prometheus</code>处理告警
<code>Prometheus</code>会记录这些告警事件,并在其状态页面上展示告警信息。<code>Prometheus</code>还可以通过<code>Webhook</code>将告警信息发送到外部系统。</li><li><code>Alertmanager</code>概述
<code>Alertmanager</code>是一个独立的告警管理组件。它支持告警去重、分组、路由、发送等功能。<code>Prometheus</code>服务器生成的告警会发送给Alertmanager。</li><li><code>Alertmanager</code>处理告警
<code>Alertmanager</code>收到告警后,可以按照定义的分组方式对其进行分组,再按照路由规则发送到对应接收方,比如邮箱、<code>Slack</code>等。它也负责告警的去重。</li><li><code>Prometheus</code>和<code>Alertmanager</code>集成
在<code>Prometheus</code>中配置<code>Alertmanager</code>的<code>URL</code>地址,这样<code>Prometheus</code>生成的告警可以自动发送到<code>Alertmanager</code>。二者集成后,可以构成动态的告警管理机制。</li></ul><p>综上,<code>Prometheus</code>负责告警检测与生成,<code>Alertmanager</code>专注于告警的后续分发、处理与告知流程。二者的集成可以完整实现从监控到告警的全链路。</p></blockquote><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/prometheus-simple-with-alertmanager.svg alt>
这里开始我们要理解<code>Prometheus</code>的告警在时序上的状态
1、<code>inactive</code>：没有触发阈值
2、<code>pending</code>：已触发阈值但未满足告警持续时间
3、<code>firing</code>：已触发阈值且满足告警持续时间</p><p>用一个简单的例子来理解一下，以下配置一个<code>mysql</code>的告警，该指标的采集周期是<code>5s</code>一个样本点，配置了规则策略是每<code>10s</code>计算一次，当运行时小于<code>30s</code>则触发告警状态。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>groups</span>:
</span></span><span style=display:flex><span>-  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>example</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>rules</span>:
</span></span><span style=display:flex><span>   - <span style=color:#f92672>alert</span>: <span style=color:#ae81ff>mysql_uptime</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>expr</span>: <span style=color:#ae81ff>mysql:server_status:uptime &lt; 30</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>for</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>         <span style=color:#f92672>level</span>: <span style=color:#e6db74>&#34;CRITICAL&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>annotations</span>:
</span></span><span style=display:flex><span>         <span style=color:#f92672>detail</span>: <span style=color:#ae81ff>数据库运行时间</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/prom-alert-ep-mysql.png alt>
如上图所示</p><ul><li>收集到的<code>mysql_uptime>=30</code>,告警状态为<code>inactive</code></li><li>收集到的<code>mysql_uptime&lt;30</code>,且持续时间小于<code>10s</code>，告警状态为<code>pending</code></li><li>收集到的<code>mysql_uptime&lt;30</code>,且持续时间大于<code>10s</code>，告警状态为<code>firing</code></li></ul><blockquote><p>⚠ 注意：配置中的for语法就是用来设置告警持续时间的；如果配置中不设置for或者设置为0，那么pending状态会被直接跳过。</p></blockquote><h3 id=告警内部逻辑>告警内部逻辑
<a class=header-anchor href=#%e5%91%8a%e8%ad%a6%e5%86%85%e9%83%a8%e9%80%bb%e8%be%91></a></h3><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/Alertmanager-logic.png alt></p><p>其内部机制可以总结为以下几个步骤:</p><ol><li>告警的接收 Alertmanager从Prometheus等地方接收到告警后,会根据配置将告警组合成分组。</li><li>告警的分组 同类或者相关的告警会聚合到一起,形成一个告警分组,这通过配置文件中的分组规则来定义。</li><li>告警的去重 对于重复的告警,Alertmanager将进行去重,防止重复发送。</li><li>告警的路由 根据告警的匹配规则,确定该告警分组的发送路径,可能是通过邮件、Slack或者Webhook发送。</li><li>沉默和抑制 根据配置直接沉默或者在告警阶段抑制某些告警信息的发送。</li><li>告警的发送 最后Alertmanager将处理后的告警通过邮件、短信、电话等方式发送给接收人。</li></ol><h2 id=联邦部署>联邦部署
<a class=header-anchor href=#%e8%81%94%e9%82%a6%e9%83%a8%e7%bd%b2></a></h2><p>当达到一定规模，我们需要多个Prometheus帮忙分担采集和计算压力，可以尝试用联邦部署的方式来扩展架构。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/Prometheus-federal.svg alt></p><blockquote><p>⚠ 注意：个人不建议这种联邦架构，主要原因是管理成本较高，且该架构对后期的自动化二次开发不太友好。</p></blockquote><h2 id=分布式架构雏型>分布式架构雏型
<a class=header-anchor href=#%e5%88%86%e5%b8%83%e5%bc%8f%e6%9e%b6%e6%9e%84%e9%9b%8f%e5%9e%8b></a></h2><p>随着业务的扩展，监控系统也随之扩大，无论从架构管理上还是稳定性考虑都要从单体架构升级到集群架构，业界有多种方案选择：</p><ul><li><code>Grafana</code>社区的<code>Cortex</code>方案</li><li><code>Thanos</code>社区方案</li></ul><p>这里选择了<code>Thanos</code>社区的分布式方案，同时在服务发现能力上引入<code>HashiCorp</code>的<code>Consul</code>来取替文件配置服务发现的能力.</p><h3 id=数据处理逻辑架构>数据处理逻辑架构
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91%e6%9e%b6%e6%9e%84></a></h3><p>通过引入<code>Consul</code>管理需被监控采集的<code>exporter采集器</code>信息，这样运维就可以通过脚本开发定时从<code>CMDB/CICD</code>系统同步基建和业务组件等可被采集的信息到该架构实现动态发现采集能力。
另外通过<code>Thanos Sidecar</code>组件同步<code>TSDB BLOCK</code>到对象存储备份。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/Thanos-Consul-Prometheus-first.svg alt></p><h3 id=数据查询逻辑架构>数据查询逻辑架构
<a class=header-anchor href=#%e6%95%b0%e6%8d%ae%e6%9f%a5%e8%af%a2%e9%80%bb%e8%be%91%e6%9e%b6%e6%9e%84></a></h3><p>前端查询用<code>Thanos Query</code>组件来实现整个分布式集群的统一入口查询能力，<code>Thanos Query</code>组件自身具备数据去重和联合查询。
历史数据可以通过<code>Thanos Compact</code>组件长周期数据聚合和降分辨率重聚合来优化底层<code>TSDB BLOCK</code> 。
对象存储的数据通过<code>Thanos Store</code>暴露API接口查询以减轻<code>Prometheus</code>的计算压力。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/Thanos-Prometheus-Query-simple.svg alt></p></div><footer class=post-footer><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="蓝宝石的傻话 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="蓝宝石的傻话 - 微信">
<span>微信</span></div></div></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/opentelemetry/prometheus-evolution-history-two/ rel=next title=监控系统企业架构演进史-跨地域混合云><i class="fa fa-chevron-left"></i> 监控系统企业架构演进史-跨地域混合云</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/old/linode-bbr-test/ rel=prev title=Linode的BBR简单测试>Linode的BBR简单测试
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>蓝宝石的傻话</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.139.3 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备2023145803号</a>
<img src=/imgs/gongan.png alt=粤公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011102001194" target=_blank>粤公网安备 44011102001194 号</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>