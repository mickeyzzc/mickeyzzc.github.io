<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.151.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.png><meta itemprop=name content="eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）"><meta itemprop=description content="What is rational is real; and what is real is rational."><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/icons/custom.png"><meta itemprop=keywords content="Tcp,DeepFlow,eBPF"><meta property="og:type" content="article"><meta property="og:title" content="eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）"><meta property="og:description" content="What is rational is real; and what is real is rational."><meta property="og:image" content="/imgs/icons/custom.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/posts/ebpf/deepflow-agent-proto-dev/"><meta property="og:site_name" content="蓝宝石的傻话"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="蓝宝石的傻话"><meta property="article:published_time" content="2023-11-25 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2023-11-25 00:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.897d85b1ab6c0aa1e97c3753fff757abafcaa5e54a5e13a94ef7d09dd61833de.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return 0[0];const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),0[0]):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"deepflow-agent-proto-dev","permalink":"/posts/ebpf/deepflow-agent-proto-dev/","title":"eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议） - 蓝宝石的傻话</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>蓝宝石的傻话</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>MickeyBee's BLOG</p><img class=custom-logo-image src=/imgs/icons/custom.png alt=蓝宝石的傻话></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>15</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#概述>概述：</a></li><li><a href=#如何分析一个协议mongodb>如何分析一个协议(MongoDB)</a><ul><li><a href=#协议文档的分析思路>协议文档的分析思路</a></li><li><a href=#mongodb协议操作码说明表>MongoDB协议操作码说明表</a></li><li><a href=#对最常见的操作码op_msg分析>对最常见的操作码<code>OP_MSG</code>分析</a></li></ul></li><li><a href=#在deepflow-agent扩展一个协议解析采集>在<code>DeepFlow Agent</code>扩展一个协议解析采集</a><ul><li><a href=#deepflow-agent的开发文档概要><code>DeepFlow Agent</code>的开发文档概要</a></li><li><a href=#代码指引>代码指引</a><ul><li><a href=#定义一个协议并用一个常量标识>定义一个协议，并用一个常量标识。</a></li><li><a href=#为新协议准备解析逻辑>为新协议准备解析逻辑</a></li></ul></li></ul></li><li><a href=#利用wasm插件扩展deepflow的协议采集>利用<code>Wasm</code>插件扩展<code>DeepFlow</code>的协议采集</a><ul><li><a href=#kafka协议分析><code>Kafka</code>协议分析</a><ul><li><a href=#kafka的header和data概览><code>Kafka</code>的<code>Header</code>和<code>Data</code>概览</a></li><li><a href=#kafka的fetch-api>Kafka的Fetch API</a></li><li><a href=#kafka的produce-api>Kafka的Produce API</a></li></ul></li><li><a href=#kafka协议deepflow-agent原生解码>Kafka协议DeepFlow Agent原生解码</a></li><li><a href=#deepflow-agent的-wasm-插件><code>DeepFlow Agent</code>的 <code>Wasm</code> 插件</a><ul><li><a href=#wasm-go-sdk-的框架>Wasm Go SDK 的框架</a></li><li><a href=#插件代码指引>插件代码指引</a></li><li><a href=#加载插件和效果展示>加载插件和效果展示</a></li></ul></li></ul></li><li><a href=#结语>结语</a><ul><li><a href=#原生rust扩展>原生Rust扩展</a></li><li><a href=#wasm插件扩展>Wasm插件扩展</a></li></ul></li><li><a href=#附录>附录</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=蓝宝石的傻话 src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpeg><p class=site-author-name itemprop=name>蓝宝石的傻话</p><div class=site-description itemprop=description>What is rational is real; and what is real is rational.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>15</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>11</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>15</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/mickeyzzc title="Github → https://github.com/mickeyzzc" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=https://gitee.com/mickeybee title="Gitee → https://gitee.com/mickeybee" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Gitee
</a></span><span class=links-of-social-item><a href=mailto:mickey_zzc@126.com title="E-Mail → mailto:mickey_zzc@126.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://blog.51cto.com/mickeyzzc title=https://blog.51cto.com/mickeyzzc target=_blank>我的51cto博客</a></li><li class=links-of-blogroll-item><a href=https://www.mlsbs.top/ title=https://www.mlsbs.top/ target=_blank>Mi&amp;Bee's Home</a></li><li class=links-of-blogroll-item><a href=https://blog.csdn.net/mickey_zzc title=https://blog.csdn.net/mickey_zzc target=_blank>CSDN博客</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2016-08-11T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=32854></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=72></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2024-02-09T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/mickeyzzc rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentColor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/ebpf/deepflow-agent-proto-dev/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）"><meta itemprop=description content="


    概述：
    



    如何分析一个协议(MongoDB)
    




    协议文档的分析思路
    



    MongoDB协议操作码说明表
    



    对最常见的操作码OP_MSG分析
    





    在DeepFlow Agent扩展一个协议解析采集
    




    DeepFlow Agent的开发文档概要
    



    代码指引
    




    定义一个协议，并用一个常量标识。
    



    为新协议准备解析逻辑
    




    定义结构体
    



    实现 L7ProtocolParserInterface
    









    利用Wasm插件扩展DeepFlow的协议采集
    




    Kafka协议分析
    




    Kafka的Header和Data概览
    



    Kafka的Fetch API
    



    Kafka的Produce API
    





    Kafka协议DeepFlow Agent原生解码
    



    DeepFlow Agent的 Wasm 插件
    




    Wasm Go SDK 的框架
    



    插件代码指引
    







    结语
    




    原生Rust扩展
    



    Wasm插件扩展
    





    附录
    





概述：

MongoDB 目前使用广泛，但是缺乏有效的可观测能力。
DeepFlow 在可观测能力上是很优秀的解决方案，但是却缺少了对 MongoDB 协议的支持。
该文是为 DeepFlow 扩展了 MongoDB 协议解析，增强 MongoDB 生态的可观测能力，简要描述了从协议文档分析到在 DeepFlow 内实现代码解析的过程拆解。"></span><header class=post-header><h1 class=post-title itemprop="name headline">eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）
<a href=https://github.com/mickeyzzc/mickeyzzcblog/tree/main/content/posts/ebpf/deepflow-agent-proto-dev.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-11-25 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-11-25 00:00:00 +0000 UTC">2023-11-25
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/ebpf itemprop=url rel=index><span itemprop=name>eBPF</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i>
</span><span class=post-meta-item-text>字数：</span>
<span>8095</span>
</span><span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i>
</span><span class=post-meta-item-text>阅读：&ap;</span>
<span>17分钟</span>
</span><span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i>
</span><span class=post-meta-item-text>浏览：
</span><span id=busuanzi_value_page_pv data-path=/posts/ebpf/deepflow-agent-proto-dev/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><ul><li><a href=#%e6%a6%82%e8%bf%b0 title=概述：>概述：</a></li><li><a href=#%e5%a6%82%e4%bd%95%e5%88%86%e6%9e%90%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%aemongodb title=如何分析一个协议(MongoDB)>如何分析一个协议(MongoDB)</a><ul><li><a href=#%e5%8d%8f%e8%ae%ae%e6%96%87%e6%a1%a3%e7%9a%84%e5%88%86%e6%9e%90%e6%80%9d%e8%b7%af title=协议文档的分析思路>协议文档的分析思路</a></li><li><a href=#mongodb%e5%8d%8f%e8%ae%ae%e6%93%8d%e4%bd%9c%e7%a0%81%e8%af%b4%e6%98%8e%e8%a1%a8 title=MongoDB协议操作码说明表>MongoDB协议操作码说明表</a></li><li><a href=#%e5%af%b9%e6%9c%80%e5%b8%b8%e8%a7%81%e7%9a%84%e6%93%8d%e4%bd%9c%e7%a0%81op_msg%e5%88%86%e6%9e%90 title=对最常见的操作码OP_MSG分析>对最常见的操作码<code>OP_MSG</code>分析</a></li></ul></li><li><a href=#%e5%9c%a8deepflow-agent%e6%89%a9%e5%b1%95%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%ae%e8%a7%a3%e6%9e%90%e9%87%87%e9%9b%86 title="在DeepFlow Agent扩展一个协议解析采集">在<code>DeepFlow Agent</code>扩展一个协议解析采集</a><ul><li><a href=#deepflow-agent%e7%9a%84%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a3%e6%a6%82%e8%a6%81 title="DeepFlow Agent的开发文档概要"><code>DeepFlow Agent</code>的开发文档概要</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e6%8c%87%e5%bc%95 title=代码指引>代码指引</a><ul><li><a href=#%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%ae%e5%b9%b6%e7%94%a8%e4%b8%80%e4%b8%aa%e5%b8%b8%e9%87%8f%e6%a0%87%e8%af%86 title=定义一个协议，并用一个常量标识。>定义一个协议，并用一个常量标识。</a></li><li><a href=#%e4%b8%ba%e6%96%b0%e5%8d%8f%e8%ae%ae%e5%87%86%e5%a4%87%e8%a7%a3%e6%9e%90%e9%80%bb%e8%be%91 title=为新协议准备解析逻辑>为新协议准备解析逻辑</a><ul><li><a href=#%e5%ae%9a%e4%b9%89%e7%bb%93%e6%9e%84%e4%bd%93 title=定义结构体>定义结构体</a></li><li><a href=#%e5%ae%9e%e7%8e%b0l7protocolparserinterface title=实现 L7ProtocolParserInterface>实现 <code>L7ProtocolParserInterface</code></a></li></ul></li></ul></li></ul></li><li><a href=#%e5%88%a9%e7%94%a8wasm%e6%8f%92%e4%bb%b6%e6%89%a9%e5%b1%95deepflow%e7%9a%84%e5%8d%8f%e8%ae%ae%e9%87%87%e9%9b%86 title=利用Wasm插件扩展DeepFlow的协议采集>利用<code>Wasm</code>插件扩展<code>DeepFlow</code>的协议采集</a><ul><li><a href=#kafka%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 title=Kafka协议分析><code>Kafka</code>协议分析</a><ul><li><a href=#kafka%e7%9a%84header%e5%92%8cdata%e6%a6%82%e8%a7%88 title=Kafka的Header和Data概览><code>Kafka</code>的<code>Header</code>和<code>Data</code>概览</a></li><li><a href=#kafka%e7%9a%84fetch-api title="Kafka的Fetch API">Kafka的Fetch API</a></li><li><a href=#kafka%e7%9a%84produce-api title="Kafka的Produce API">Kafka的Produce API</a></li></ul></li><li><a href=#kafka%e5%8d%8f%e8%ae%aedeepflow-agent%e5%8e%9f%e7%94%9f%e8%a7%a3%e7%a0%81 title="Kafka协议DeepFlow Agent原生解码">Kafka协议DeepFlow Agent原生解码</a></li><li><a href=#deepflow-agent%e7%9a%84-wasm-%e6%8f%92%e4%bb%b6 title="DeepFlow Agent的 Wasm 插件"><code>DeepFlow Agent</code>的 <code>Wasm</code> 插件</a><ul><li><a href=#wasm-go-sdk-%e7%9a%84%e6%a1%86%e6%9e%b6 title="Wasm Go SDK 的框架">Wasm Go SDK 的框架</a></li><li><a href=#%e6%8f%92%e4%bb%b6%e4%bb%a3%e7%a0%81%e6%8c%87%e5%bc%95 title=插件代码指引>插件代码指引</a></li></ul></li></ul></li><li><a href=#%e7%bb%93%e8%af%ad title=结语>结语</a><ul><li><a href=#%e5%8e%9f%e7%94%9frust%e6%89%a9%e5%b1%95 title=原生Rust扩展>原生Rust扩展</a></li><li><a href=#wasm%e6%8f%92%e4%bb%b6%e6%89%a9%e5%b1%95 title=Wasm插件扩展>Wasm插件扩展</a></li></ul></li><li><a href=#%e9%99%84%e5%bd%95 title=附录>附录</a></li></ul><div style=position:relative;padding-bottom:75%;width:100%;height:0><iframe src="//player.bilibili.com/player.html?isOutside=true&aid=921401645&bvid=BV1Nu4y1A7ZC&cid=1345829549&p=1" scrolling=no border=0 frameborder=no framespacing=0 allowfullscreen style=position:absolute;height:100%;width:100%></iframe></div><h2 id=概述>概述：
<a class=header-anchor href=#%e6%a6%82%e8%bf%b0></a></h2><p><code>MongoDB</code> 目前使用广泛，但是缺乏有效的可观测能力。
<code>DeepFlow</code> 在可观测能力上是很优秀的解决方案，但是却缺少了对 <code>MongoDB</code> 协议的支持。
该文是为 <code>DeepFlow</code> 扩展了 <code>MongoDB</code> 协议解析，增强 <code>MongoDB</code> 生态的可观测能力，简要描述了从协议文档分析到在 <code>DeepFlow</code> 内实现代码解析的过程拆解。</p><h2 id=如何分析一个协议mongodb>如何分析一个协议(MongoDB)
<a class=header-anchor href=#%e5%a6%82%e4%bd%95%e5%88%86%e6%9e%90%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%aemongodb></a></h2><h3 id=协议文档的分析思路>协议文档的分析思路
<a class=header-anchor href=#%e5%8d%8f%e8%ae%ae%e6%96%87%e6%a1%a3%e7%9a%84%e5%88%86%e6%9e%90%e6%80%9d%e8%b7%af></a></h3><p>首先要从官方网站找到协议解析的文档，在协议文档
<a href=https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#standard-message-header title=《mongodb-wire-protocol#standard-message-header》 rel="noopener external nofollow noreferrer" target=_blank class=exturl>《mongodb-wire-protocol#standard-message-header》
<i class="fa fa-external-link-alt"></i>
</a>中，可以看到<code>MongoDB</code>的协议头结构体描述如下：</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> MsgHeader {
</span></span><span style=display:flex><span>    int32   messageLength;     <span style=color:#75715e>// total message size, including this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    int32   requestID;         <span style=color:#75715e>// identifier for this message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    int32   responseTo;        <span style=color:#75715e>// requestID from the original request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                               <span style=color:#75715e>//   (used in responses from the database)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    int32   opCode;            <span style=color:#75715e>// message type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></td></tr></table></div></div><p>上述结构代码理解为下图所示：</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/MongoDB-Msg-Header.svg alt></p><blockquote><p>注意，在协议文档
<a href=https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/ title=《mongodb-wire-protocol》 rel="noopener external nofollow noreferrer" target=_blank class=exturl>《mongodb-wire-protocol》
<i class="fa fa-external-link-alt"></i>
</a>有一段说明，MongoDB协议是用了字节小端顺序。</p><blockquote><p><strong>Byte Ordering</strong><br>All integers in the MongoDB wire protocol use <strong>little-endian byte order: that is, least-significant</strong></p></blockquote></blockquote><p>接下来从实际的抓包看一下实际的数据是长什么样子的。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/mongo-pcap.png alt></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>0000   a3 00 00 00 0a 50 88 48 23 00 00 00 dd 07 00 00
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>0010   00 00 00 00 00 8e 00 00 00 01 6f 6b 00 00 00 00
</span></span><span style=display:flex><span>0020   00 00 00 f0 3f 11 6f 70 65 72 61 74 69 6f 6e 54
</span></span><span style=display:flex><span>0030   69 6d 65 00 01 00 00 00 bc 1d c3 64 03 24 63 6c
</span></span><span style=display:flex><span>0040   75 73 74 65 72 54 69 6d 65 00 58 00 00 00 11 63
</span></span><span style=display:flex><span>0050   6c 75 73 74 65 72 54 69 6d 65 00 01 00 00 00 bc
</span></span><span style=display:flex><span>0060   1d c3 64 03 73 69 67 6e 61 74 75 72 65 00 33 00
</span></span><span style=display:flex><span>0070   00 00 05 68 61 73 68 00 14 00 00 00 00 29 12 d4
</span></span><span style=display:flex><span>0080   7f 78 52 55 42 04 29 2f b7 36 85 39 c1 47 66 05
</span></span><span style=display:flex><span>0090   de 12 6b 65 79 49 64 00 01 00 00 00 8c d2 e4 63
</span></span><span style=display:flex><span>00a0   00 00 00
</span></span></code></pre></td></tr></table></div></div><blockquote><p>上述的抓包数据简单拆解到如下信息：</p><ul><li>字段<code>messageLength</code>为<code>a3 00 00 00</code> ：即 消息长度为 <code>a3</code></li><li>字段<code>requestID</code>为<code>0a 50 88 48</code>：即 请求ID为<code>4888500a</code></li><li>字段<code>responseTo</code>为<code>23 00 00 00</code>：即 对ID为<code>23</code>的响应</li><li>字段<code>opCode</code>为<code>dd 07 00 00</code>：即 命令号为 <code>7dd</code>，十进制是<code>2013</code>，对应协议文档中的<code>OP_MSG</code>指令。</li></ul></blockquote><h3 id=mongodb协议操作码说明表>MongoDB协议操作码说明表
<a class=header-anchor href=#mongodb%e5%8d%8f%e8%ae%ae%e6%93%8d%e4%bd%9c%e7%a0%81%e8%af%b4%e6%98%8e%e8%a1%a8></a></h3><table><thead><tr><th>操作码名称</th><th>操作码</th><th>操作码说明</th><th>额外说明</th></tr></thead><tbody><tr><td>OP_COMPRESSED</td><td>2012</td><td>使用压缩</td><td></td></tr><tr><td>OP_MSG</td><td>2013</td><td>Send a message using the standard format. Used for both client requests and database replies.</td><td></td></tr><tr><td>OP_REPLY</td><td>1</td><td>通过responseTo指定响应客户端请求。</td><td>Deprecated in MongoDB 5.0. Removed in MongoDB 5.1.</td></tr><tr><td>OP_UPDATE</td><td>2001</td><td>更新文档</td><td>Deprecated in MongoDB 5.0. Removed in MongoDB 5.1.</td></tr><tr><td>OP_INSERT</td><td>2002</td><td>插入文档</td><td>Deprecated in MongoDB 5.0. Removed in MongoDB 5.1.</td></tr><tr><td>RESERVED</td><td>2003</td><td>略</td><td></td></tr><tr><td>OP_QUERY</td><td>2004</td><td>查询文档</td><td>Deprecated in MongoDB 5.0. Removed in MongoDB 5.1.</td></tr><tr><td>OP_GET_MORE</td><td>2005</td><td>略</td><td>Deprecated in MongoDB 5.0. Removed in MongoDB 5.1.</td></tr><tr><td>OP_DELETE</td><td>2006</td><td>删除文档</td><td>Deprecated in MongoDB 5.0. Removed in MongoDB 5.1.</td></tr><tr><td>OP_KILL_CURSORS</td><td>2007</td><td>略</td><td>Deprecated in MongoDB 5.0. Removed in MongoDB 5.1.</td></tr></tbody></table><h3 id=对最常见的操作码op_msg分析>对最常见的操作码<code>OP_MSG</code>分析
<a class=header-anchor href=#%e5%af%b9%e6%9c%80%e5%b8%b8%e8%a7%81%e7%9a%84%e6%93%8d%e4%bd%9c%e7%a0%81op_msg%e5%88%86%e6%9e%90></a></h3><p>从协议文档
<a href=https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#op_msg title=《mongodb-wire-protocol#op_msg》 rel="noopener external nofollow noreferrer" target=_blank class=exturl>《mongodb-wire-protocol#op_msg》
<i class="fa fa-external-link-alt"></i>
</a>查看<code>OP_MSG</code>的结构体</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span>OP_MSG {
</span></span><span style=display:flex><span>    MsgHeader header;              <span style=color:#75715e>// standard message header
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    uint32 flagBits;               <span style=color:#75715e>// message flags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Sections[] sections;           <span style=color:#75715e>// data sections
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    optional<span style=color:#f92672>&lt;</span>uint32<span style=color:#f92672>&gt;</span> checksum;     <span style=color:#75715e>// optional CRC-32C checksum
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p><code>OP_MSG</code>需要关注的解码内容在<code>Sections</code>，只需要判断<code>kind</code>为<code>0</code>和<code>1</code>的情况，其中：</p><ul><li>0：后面直接用<code>BSON</code>解码；</li><li>1：先偏移<code>int32</code>和<code>c_string</code>占用的<code>byte</code>后，用<code>BSON</code>解码后面的内容</li></ul></blockquote><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/MongoDB-OPMSG.svg alt></p><p>从实际抓包看一下原始数据。如下所示，MongoDB协议的操作码<code>OP_MSG</code>内容从第十六（从0开始数，后续文档统一按此规律）字节开始。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/mongo-op-msg-pcap.png alt></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>0000   a3 00 00 00 0a 50 88 48 23 00 00 00 dd 07 00 00
</span></span><span style=display:flex><span>0010   00 00 00 00 
</span></span><span style=display:flex><span>                   00 
</span></span><span style=display:flex><span>                      8e 00 00 00 01 6f 6b 00 00 00 00
</span></span><span style=display:flex><span>0020   00 00 00 f0 3f 11 6f 70 65 72 61 74 69 6f 6e 54
</span></span><span style=display:flex><span>0030   69 6d 65 00 01 00 00 00 bc 1d c3 64 03 24 63 6c
</span></span><span style=display:flex><span>0040   75 73 74 65 72 54 69 6d 65 00 58 00 00 00 11 63
</span></span><span style=display:flex><span>0050   6c 75 73 74 65 72 54 69 6d 65 00 01 00 00 00 bc
</span></span><span style=display:flex><span>0060   1d c3 64 03 73 69 67 6e 61 74 75 72 65 00 33 00
</span></span><span style=display:flex><span>0070   00 00 05 68 61 73 68 00 14 00 00 00 00 29 12 d4
</span></span><span style=display:flex><span>0080   7f 78 52 55 42 04 29 2f b7 36 85 39 c1 47 66 05
</span></span><span style=display:flex><span>0090   de 12 6b 65 79 49 64 00 01 00 00 00 8c d2 e4 63
</span></span><span style=display:flex><span>00a0   00 00 00
</span></span></code></pre></td></tr></table></div></div><blockquote><p>不需要关心字段<code>flagBits</code>，偏移4个字节后从第四个字节判断字段<code>kind</code>类型。由此判断后面为<code>BSON</code>结构数据。</p></blockquote><p>到这里我们已经基本了解到<code>MongoDB</code>协议的数据结构和解码思路了，接下来我们开始在<code>DeepFlow Agent</code>中尝试实现解码观察。</p><h2 id=在deepflow-agent扩展一个协议解析采集>在<code>DeepFlow Agent</code>扩展一个协议解析采集
<a class=header-anchor href=#%e5%9c%a8deepflow-agent%e6%89%a9%e5%b1%95%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%ae%e8%a7%a3%e6%9e%90%e9%87%87%e9%9b%86></a></h2><h3 id=deepflow-agent的开发文档概要><code>DeepFlow Agent</code>的开发文档概要
<a class=header-anchor href=#deepflow-agent%e7%9a%84%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a3%e6%a6%82%e8%a6%81></a></h3><blockquote><p>前提，<code>DeepFlow Agent</code>的原生开发需要掌握<code>Rust</code>语言的基础开发能力。
接下来先参考官方文档
<a href=https://github.com/deepflowio/deepflow/blob/main/docs/HOW_TO_SUPPORT_YOUR_PROTOCOL_CN.MD title=《HOW_TO_SUPPORT_YOUR_PROTOCOL_CN》 rel="noopener external nofollow noreferrer" target=_blank class=exturl>《HOW_TO_SUPPORT_YOUR_PROTOCOL_CN》
<i class="fa fa-external-link-alt"></i>
</a>了解几个关键信息</p></blockquote><ul><li><p><code>L7Protocol</code> 用于标识协议常量
源码位置：<code>deepflow/agent/crates/public/src/l7_protocol.rs</code></p></li><li><p><code>L7ProtocolParser</code> 主要用于协议判断和解析出 <code>L7ProtocolInfo</code>(七层协议的基础结构信息)
源码位置：<code>deepflow/agent/src/common/l7_protocol_log.rs</code></p></li><li><p><code>L7ProtocolInfo</code> 由 <code>L7ProtocolParser</code> 解析出来，并且用于后续会话聚合
源码位置：<code>deepflow/agent/src/common/l7_protocol_info.rs</code></p></li><li><p><code>L7ProtocolInfoInterface</code> 七层协议结构<code>L7ProtocolInfo</code> 都需要实现这个接口来处理特征逻辑
源码位置：<code>deepflow/agent/src/common/l7_protocol_info.rs</code></p></li><li><p><code>L7ProtocolSendLog</code> 统一发送到 <code>deepflow-server</code> 的结构
源码位置：<code>deepflow/agent/src/flow_generator/protocol_logs/pb_adapter.rs</code></p></li></ul><blockquote><p>在 <code>deepflow-agent</code> 中开发的大致步骤：</p><ul><li>在 <code>“deepflow/agent/crates/public/src/l7_protocol.rs”</code> 添加对应协议名称和协议号。</li><li><code>L7ProtocolParser::parse_payload()</code> 需要返回 <code>L7ProtocolInfo</code>，所以需要先定义一个结构，实现 <code>L7ProtocolInfoInterface</code> 接口并且添加到  <code>L7ProtocolInfo</code> 这个枚举。</li><li>实现 <code>L7ProtocolParserInterface</code> 接口，并添加到<code>“deepflow/agent/src/common/l7_protocol_log.rs”</code>中的 <code>impl_protocol_parser! </code>宏。</li><li>在 <code>deepflow-server</code> 中只需增加一个常量用于搜索提示即可。</li></ul></blockquote><h3 id=代码指引>代码指引
<a class=header-anchor href=#%e4%bb%a3%e7%a0%81%e6%8c%87%e5%bc%95></a></h3><h4 id=定义一个协议并用一个常量标识>定义一个协议，并用一个常量标识。
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%ae%e5%b9%b6%e7%94%a8%e4%b8%80%e4%b8%aa%e5%b8%b8%e9%87%8f%e6%a0%87%e8%af%86></a></h4><blockquote><p>源码位置：<code>deepflow/agent/crates/public/src/l7_protocol.rs</code>，<code>Agent</code> 通过遍历所有支持协议判断一个流的应用层协议。
这里说明一下，由于业界的通用应用协议没有一个约束字段来定义应用协议类型，所以在大量网络包是通过遍历已知协议解码逻辑来判断应用层协议的。</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>L7Protocol</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[num_enum(default)]</span>
</span></span><span style=display:flex><span>    Unknown <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    Other <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// HTTP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Http1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>    Http2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>21</span>,
</span></span><span style=display:flex><span>    Http1TLS <span style=color:#f92672>=</span> <span style=color:#ae81ff>22</span>,
</span></span><span style=display:flex><span>    Http2TLS <span style=color:#f92672>=</span> <span style=color:#ae81ff>23</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// RPC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Dubbo <span style=color:#f92672>=</span> <span style=color:#ae81ff>40</span>,
</span></span><span style=display:flex><span>    Grpc <span style=color:#f92672>=</span> <span style=color:#ae81ff>41</span>,
</span></span><span style=display:flex><span>    SofaRPC <span style=color:#f92672>=</span> <span style=color:#ae81ff>43</span>,
</span></span><span style=display:flex><span>    FastCGI <span style=color:#f92672>=</span> <span style=color:#ae81ff>44</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SQL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    MySQL <span style=color:#f92672>=</span> <span style=color:#ae81ff>60</span>,
</span></span><span style=display:flex><span>    PostgreSQL <span style=color:#f92672>=</span> <span style=color:#ae81ff>61</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// NoSQL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Redis <span style=color:#f92672>=</span> <span style=color:#ae81ff>80</span>,
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>   MongoDB <span style=color:#f92672>=</span> <span style=color:#ae81ff>81</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// MQ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Kafka <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>MQTT</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>101</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// INFRA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>DNS</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>120</span>,
</span></span><span style=display:flex><span>    Custom <span style=color:#f92672>=</span> <span style=color:#ae81ff>127</span>,
</span></span><span style=display:flex><span>    Max <span style=color:#f92672>=</span> <span style=color:#ae81ff>255</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> From<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> L7Protocol {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>from</span>(l7_protocol_str: String) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> l7_protocol_str <span style=color:#f92672>=</span> l7_protocol_str.to_lowercase();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> l7_protocol_str.as_str() {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;http&#34;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#34;https&#34;</span> <span style=color:#f92672>=&gt;</span> Self::Http1,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;dubbo&#34;</span> <span style=color:#f92672>=&gt;</span> Self::Dubbo,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;grpc&#34;</span> <span style=color:#f92672>=&gt;</span> Self::Grpc,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;fastcgi&#34;</span> <span style=color:#f92672>=&gt;</span> Self::FastCGI,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;custom&#34;</span> <span style=color:#f92672>=&gt;</span> Self::Custom,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;sofarpc&#34;</span> <span style=color:#f92672>=&gt;</span> Self::SofaRPC,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;mysql&#34;</span> <span style=color:#f92672>=&gt;</span> Self::MySQL,
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>           <span style=color:#e6db74>&#34;mongodb&#34;</span> <span style=color:#f92672>=&gt;</span> Self::MongoDB,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;postgresql&#34;</span> <span style=color:#f92672>=&gt;</span> Self::PostgreSQL,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;redis&#34;</span> <span style=color:#f92672>=&gt;</span> Self::Redis,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;kafka&#34;</span> <span style=color:#f92672>=&gt;</span> Self::Kafka,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;mqtt&#34;</span> <span style=color:#f92672>=&gt;</span> Self::<span style=color:#66d9ef>MQTT</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;dns&#34;</span> <span style=color:#f92672>=&gt;</span> Self::<span style=color:#66d9ef>DNS</span>,
</span></span><span style=display:flex><span>            _ <span style=color:#f92672>=&gt;</span> Self::Unknown,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h4 id=为新协议准备解析逻辑>为新协议准备解析逻辑
<a class=header-anchor href=#%e4%b8%ba%e6%96%b0%e5%8d%8f%e8%ae%ae%e5%87%86%e5%a4%87%e8%a7%a3%e6%9e%90%e9%80%bb%e8%be%91></a></h4><h5 id=定义结构体>定义结构体
<a class=header-anchor href=#%e5%ae%9a%e4%b9%89%e7%bb%93%e6%9e%84%e4%bd%93></a></h5><p>在<code>“deepflow/agent/src/flow_generator/protocol_logs/”</code>该路径下找一个目录建立相关的协议解析逻辑代码文件，该案例的代码文件放在上述目录下的<code>“sql/mongo.rs”</code>。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MongoDBInfo</span> {
</span></span><span style=display:flex><span>    msg_type: <span style=color:#a6e22e>LogMessageType</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;req_len&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> req_len: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;resp_len&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> resp_len: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>//// 参考“deepflow/agent/src/flow_generator/protocol_logs/pb_adapter.rs” 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//   准备要处理的结构体。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//   其中“request_id”、“response_id”、“op_code”和“op_code_name”是
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//   从mongodb header解析出来的关键信息。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;request_id&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> request_id: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;response_id&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> response_id: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;op_code&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> op_code: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(skip)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> op_code_name: String,
</span></span><span style=display:flex><span>    <span style=color:#75715e>//// “request”、“response”和“response_code”是
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//   从mongodb协议主体内容解析出来的所需信息。
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;request_resource&#34;</span><span style=color:#75715e>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> request: String,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(skip)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> response: String,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;response_code&#34;</span><span style=color:#75715e>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> response_code: <span style=color:#66d9ef>i32</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>////
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>#[serde(rename = </span><span style=color:#e6db74>&#34;response_status&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> status: <span style=color:#a6e22e>L7ResponseStatus</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h5 id=实现l7protocolparserinterface>实现 <code>L7ProtocolParserInterface</code>
<a class=header-anchor href=#%e5%ae%9e%e7%8e%b0l7protocolparserinterface></a></h5><ul><li>先看源码结构逻辑（以下只显示需处理函数，不需处理的保留默认逻辑即可）</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[enum_dispatch]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>trait</span> L7ProtocolParserInterface {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>check_payload</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>], param: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>ParseParam</span>) -&gt; <span style=color:#66d9ef>bool</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 协议解析
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse_payload</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>], param: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>ParseParam</span>) -&gt; Result<span style=color:#f92672>&lt;</span>L7ParseResult<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 返回协议号和协议名称，由于的bitmap使用u128，所以协议号不能超过128.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 其中 crates/public/src/l7_protocol.rs 里面的 pub const L7_PROTOCOL_xxx 是已实现的协议号.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ===========================================================================================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// return protocol number and protocol string. because of bitmap use u128, so the max protocol number can not exceed 128
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// crates/public/src/l7_protocol.rs, pub const L7_PROTOCOL_xxx is the implemented protocol.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>protocol</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>L7Protocol</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// l4是tcp时是否解析，用于快速过滤协议
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ==============================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// whether l4 is parsed when tcp, use for quickly protocol filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parsable_on_tcp</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// l4是udp是是否解析，用于快速过滤协议
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// ==============================
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// whether l4 is parsed when udp, use for quickly protocol filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parsable_on_udp</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// return perf data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>perf_stats</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self) -&gt; Option<span style=color:#f92672>&lt;</span>L7PerfStats<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>解码协议的第一步是如何识别协议，代码中需处理 <code>L7ProtocolParserInterface::check_payload()</code>逻辑</p><ul><li>定义<code>MongoDB</code>协议头并解码</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>// 定义MongoDB协议头结构体，并对必要信息字段一一解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#[derive(Clone, Debug, Default, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MongoDBHeader</span> {
</span></span><span style=display:flex><span>    length: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    request_id: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    response_to: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    op_code: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    op_code_name: String,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> MongoDBHeader {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; <span style=color:#66d9ef>isize</span> {
</span></span><span style=display:flex><span> <span style=color:#75715e>// 对payload前16位以MongoDBHeader结构解码，判断是否符合MongoDB的协议
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>is_request</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span> <span style=color:#75715e>// 解码op_code判断是否request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>get_op_str</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>&amp;</span>&#39;static <span style=color:#66d9ef>str</span> {
</span></span><span style=display:flex><span> <span style=color:#75715e>// 解码op_code出对应文本描述
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>在<code>L7ProtocolParserInterface::check_payload()</code>调用<code>MongoDB</code>协议头解码逻辑
在此过程，把<code>protocol(&amp;self)</code>和<code>parsable_on_udp(&amp;self)</code>也一并处理。</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> L7ProtocolParserInterface <span style=color:#66d9ef>for</span> MongoDBLog {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>check_payload</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>], param: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>ParseParam</span>) -&gt; <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> header <span style=color:#f92672>=</span> MongoDBHeader::default();
</span></span><span style=display:flex><span>        header.decode(payload);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> header.is_request();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>protocol</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>L7Protocol</span> {
</span></span><span style=display:flex><span>        L7Protocol::MongoDB
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// udp协议的跳过解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parsable_on_udp</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>bool</span> {<span style=color:#66d9ef>false</span>}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>第一步的效果展示
到这一步的解码将会得到如下展示效果，接下来还需要对具体的协议操作码做进一步解码。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/grafana-deepflow-mongo-01.png alt></li></ul></li><li><p>解码协议的第二步是对关键指令定义结构体和解码接口逻辑实现，对应处理是<code>L7ProtocolParserInterface::parse_payload()</code>代码实现，这里以<code>OP_MSG</code>为例</p><ul><li>定义<code>OP_MSG</code>操作码的结构体并解码</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Clone, Debug, Default, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MongoOpMsg</span> {
</span></span><span style=display:flex><span>    flag: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    sections: <span style=color:#a6e22e>Sections</span>,
</span></span><span style=display:flex><span>    checksum: Option<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u32</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> MongoOpMsg {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; Result<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 略过偏移逻辑
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>let</span> _ <span style=color:#f92672>=</span> sections.decode(<span style=color:#f92672>&amp;</span>payload);
</span></span><span style=display:flex><span>        self.sections <span style=color:#f92672>=</span> sections;
</span></span><span style=display:flex><span>        Ok(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>对<code>OP_MSG</code>操作码中业务需要关注的字段<code>Sections</code>做进一步解码</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Clone, Debug, Default, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Sections</span> {
</span></span><span style=display:flex><span>    kind: <span style=color:#66d9ef>u8</span>,
</span></span><span style=display:flex><span>    kind_name: String,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// kind: 0 mean doc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    doc: <span style=color:#a6e22e>Document</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// kind: 1 mean body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    size: Option<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>i32</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    c_string: Option<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> Sections {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>]) -&gt; Result<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> self.kind {
</span></span><span style=display:flex><span>            <span style=color:#ae81ff>0</span> <span style=color:#f92672>=&gt;</span> {<span style=color:#75715e>// Body}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#ae81ff>1</span> <span style=color:#f92672>=&gt;</span> {<span style=color:#75715e>// Doc}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#ae81ff>2</span> <span style=color:#f92672>=&gt;</span> {<span style=color:#75715e>// Internal}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            _ <span style=color:#f92672>=&gt;</span> {<span style=color:#75715e>// Unknown}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>        Ok(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>处理 <code>L7ProtocolParserInterface::parse_payload</code>，返回 <code>L7ProtocolInfo</code></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[derive(Clone, Debug, Default, Serialize)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MongoDBLog</span> {
</span></span><span style=display:flex><span>    info: <span style=color:#a6e22e>MongoDBInfo</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>#[serde(skip)]</span>
</span></span><span style=display:flex><span>    perf_stats: Option<span style=color:#f92672>&lt;</span>L7PerfStats<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> L7ProtocolParserInterface <span style=color:#66d9ef>for</span> MongoDBLog {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse_payload</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>], param: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>ParseParam</span>) -&gt; Result<span style=color:#f92672>&lt;</span>L7ParseResult<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> info <span style=color:#f92672>=</span> MongoDBInfo::default();
</span></span><span style=display:flex><span>        self.parse(payload, param.l4_protocol, param.direction, <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> info)<span style=color:#f92672>?</span>;  <span style=color:#75715e>// 解码得到L7ProtocolInfo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> MongoDBLog {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self,payload:<span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>],proto:<span style=color:#a6e22e>IpProtocol</span>,dir:<span style=color:#a6e22e>PacketDirection</span>,info:<span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> MongoDBInfo,)-&gt; Result<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span> { <span style=color:#75715e>// 解码指令获取请求和响应等信息}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	    <span style=color:#75715e>// command decode
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#66d9ef>match</span> info.op_code {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>_OP_MSG</span> <span style=color:#66d9ef>if</span> payload.len() <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>_MSG_DOC_SECTION_OFFSET</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// OP_MSG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> msg_body <span style=color:#f92672>=</span> MongoOpMsg::default();	
</span></span><span style=display:flex><span>				<span style=color:#75715e>// TODO: Message Flags
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				msg_body.decode(<span style=color:#f92672>&amp;</span>payload[<span style=color:#66d9ef>_MSG_DOC_SECTION_OFFSET</span><span style=color:#f92672>..</span>])<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>为<code>MongoDBInfo</code>实现<code>L7ProtocolInfoInterface</code></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> L7ProtocolInfoInterface <span style=color:#66d9ef>for</span> MongoDBInfo {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>session_id</span>(<span style=color:#f92672>&amp;</span>self) -&gt; Option<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u32</span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 这里返回流标识id，例如 http2 返回 streamid，dns 返回 transaction id，如果没有就返回 None
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>merge_log</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, other: <span style=color:#a6e22e>L7ProtocolInfo</span>) -&gt; Result<span style=color:#f92672>&lt;</span>()<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span> <span style=color:#75715e>// 这里的self必定是请求，other必定是响应
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> L7ProtocolInfo::MongoDBInfo(other) <span style=color:#f92672>=</span> other {
</span></span><span style=display:flex><span>            self.merge(other);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        Ok(())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>app_proto_head</span>(<span style=color:#f92672>&amp;</span>self) -&gt; Option<span style=color:#f92672>&lt;</span>AppProtoHead<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span> <span style=color:#75715e>// 这里返回一个 AppProtoHead 结构，返回 None 直接丢弃这段数据
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Some(AppProtoHead {
</span></span><span style=display:flex><span>            proto: <span style=color:#a6e22e>L7Protocol</span>::MongoDB,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>is_tls</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        self.is_tls
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>为<code>MongoDBInfo</code>实现<code>L7ProtocolSendLog</code></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> From<span style=color:#f92672>&lt;</span>MongoDBInfo<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> L7ProtocolSendLog {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>from</span>(f: <span style=color:#a6e22e>MongoDBInfo</span>) -&gt; <span style=color:#a6e22e>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> log <span style=color:#f92672>=</span> L7ProtocolSendLog {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 这里需要把 info 转换成统一的发送结构 L7ProtocolSendLog
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        };
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> log;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 参考源码来自：deepflow/agent/src/flow_generator/protocol_logs/pb_adapter.rs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>L7ProtocolSendLog</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> req_len: Option<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u32</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> resp_len: Option<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>u32</span><span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> row_effect: <span style=color:#66d9ef>u32</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> req: <span style=color:#a6e22e>L7Request</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> resp: <span style=color:#a6e22e>L7Response</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> version: Option<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> trace_info: Option<span style=color:#f92672>&lt;</span>TraceInfo<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> ext_info: Option<span style=color:#f92672>&lt;</span>ExtendedInfo<span style=color:#f92672>&gt;</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>把实现<code>L7ProtocolParserInterface</code>的接口，添加到<code>deepflow/agent/src/common/l7_protocol_log.rs</code>中的<code>impl_protocol_parser!</code>宏。</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a6e22e>impl_protocol_parser!</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>L7ProtocolParser</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// http have two version but one parser, can not place in macro param.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// custom must in frist so can not place in macro
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>DNS</span>(DnsLog),
</span></span><span style=display:flex><span>        SofaRPC(SofaRpcLog),
</span></span><span style=display:flex><span>        MySQL(MysqlLog),
</span></span><span style=display:flex><span>        Kafka(KafkaLog),
</span></span><span style=display:flex><span>        Redis(RedisLog),
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>       MongoDB(MongoDBLog),
</span></span><span style=display:flex><span>        PostgreSQL(PostgresqlLog),
</span></span><span style=display:flex><span>        Dubbo(DubboLog),
</span></span><span style=display:flex><span>        FastCGI(FastCGILog),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>MQTT</span>(MqttLog),
</span></span><span style=display:flex><span>        <span style=color:#75715e>// add protocol below
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>第二步的效果
<img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/grafana-deepflow-mongo-02.png alt></li></ul></li><li><p>通过<code>perf_states</code>统计记录<code>QPS</code>、<code>耗时</code>和<code>异常</code>情况</p></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span> L7ProtocolParserInterface <span style=color:#66d9ef>for</span> MongoDBLog {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse_payload</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self, payload: <span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>], param: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>ParseParam</span>) -&gt; Result<span style=color:#f92672>&lt;</span>L7ParseResult<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> info <span style=color:#f92672>=</span> MongoDBInfo::default();
</span></span><span style=display:flex><span>        self.parse(payload, param.l4_protocol, param.direction, <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> info)<span style=color:#f92672>?</span>;  <span style=color:#75715e>// 解码得到L7ProtocolInfo
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        info.cal_rrt(param, None).map(<span style=color:#f92672>|</span>rrt<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>            info.rrt <span style=color:#f92672>=</span> rrt;
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>           self.perf_stats.as_mut().map(<span style=color:#f92672>|</span>p<span style=color:#f92672>|</span> p.update_rrt(rrt)); <span style=color:#75715e>// 耗时
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> MongoDBLog {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>parse</span>(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> self,payload:<span style=color:#66d9ef>&amp;</span>[<span style=color:#66d9ef>u8</span>],proto:<span style=color:#a6e22e>IpProtocol</span>,dir:<span style=color:#a6e22e>PacketDirection</span>,info:<span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> MongoDBInfo,) -&gt; Result<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>bool</span><span style=color:#f92672>&gt;</span> { <span style=color:#75715e>// 解码指令获取请求和响应等信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> header.is_request() {
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>           self.perf_stats.as_mut().map(<span style=color:#f92672>|</span>p: <span style=color:#66d9ef>&amp;</span><span style=color:#a6e22e>mut</span> L7PerfStats<span style=color:#f92672>|</span> p.inc_req()); <span style=color:#75715e>// 请求记录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>           self.perf_stats.as_mut().map(<span style=color:#f92672>|</span>p<span style=color:#f92672>|</span> p.inc_resp()); <span style=color:#75715e>// 响应记录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>match</span> info.op_code {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>_OP_REPLY</span> <span style=color:#66d9ef>if</span> payload.len() <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>_HEADER_SIZE</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> msg_body <span style=color:#f92672>=</span> MongoOpReply::default();
</span></span><span style=display:flex><span>                msg_body.decode(<span style=color:#f92672>&amp;</span>payload[<span style=color:#66d9ef>_HEADER_SIZE</span><span style=color:#f92672>..</span>])<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>msg_body.reply_ok {
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>                   self.perf_stats.as_mut().map(<span style=color:#f92672>|</span>p<span style=color:#f92672>|</span> p.inc_resp_err());<span style=color:#75715e>// 异常记录
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>效果如图：
<img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/grafana-deepflow-mongo-03.png alt></p><ul><li>最后在<code>server</code>补充服务端的协议识别
以下两部分内容在代码文件<code>server/libs/datatype/flow.go</code>中</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>L7Protocol</span> <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_UNKNOWN</span>    <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_OTHER</span>      <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_HTTP_1</span>     <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_HTTP_2</span>     <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>21</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_HTTP_1_TLS</span> <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>22</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_HTTP_2_TLS</span> <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>23</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_DUBBO</span>      <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>40</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_GRPC</span>       <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>41</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_SOFARPC</span>    <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>43</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_FASTCGI</span>    <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>44</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_MYSQL</span>      <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_POSTGRE</span>    <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>61</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_REDIS</span>      <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>   <span style=color:#a6e22e>L7_PROTOCOL_MONGODB</span>    <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>81</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_KAFKA</span>      <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_MQTT</span>       <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>101</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_DNS</span>        <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>120</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>L7_PROTOCOL_CUSTOM</span>     <span style=color:#a6e22e>L7Protocol</span> = <span style=color:#ae81ff>127</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>L7Protocol</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>formatted</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>p</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_HTTP_1</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;HTTP&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_DNS</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;DNS&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_MYSQL</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;MySQL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_POSTGRE</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;PostgreSQL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_REDIS</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;Redis&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>   <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_MONGODB</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>       <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;MongoDB&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_DUBBO</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;Dubbo&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_GRPC</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;gRPC&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_CUSTOM</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;Custom&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>L7_PROTOCOL_OTHER</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;Others&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>formatted</span> = <span style=color:#e6db74>&#34;N/A&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>formatted</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>server/querier/db_descriptions/clickhouse/tag/enum/l7_protocol</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>Value</span> , <span style=color:#a6e22e>DisplayName</span>     , <span style=color:#a6e22e>Description</span>
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>0</span>       , <span style=color:#a6e22e>N</span><span style=color:#f92672>/</span><span style=color:#a6e22e>A</span>             ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>1</span>       , <span style=color:#a6e22e>Others</span>          ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>20</span>      , <span style=color:#a6e22e>HTTP</span>            ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>21</span>      , <span style=color:#a6e22e>HTTP2</span>           ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>22</span>      , <span style=color:#a6e22e>HTTP1_TLS</span>       ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>23</span>      , <span style=color:#a6e22e>HTTP2_TLS</span>       ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>40</span>      , <span style=color:#a6e22e>Dubbo</span>           ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>41</span>      , <span style=color:#a6e22e>gRPC</span>            ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>43</span>      , <span style=color:#a6e22e>SOFARPC</span>         ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>44</span>      , <span style=color:#a6e22e>FastCGI</span>         ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>60</span>      , <span style=color:#a6e22e>MySQL</span>           ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>61</span>      , <span style=color:#a6e22e>PostgreSQL</span>      ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>80</span>      , <span style=color:#a6e22e>Redis</span>           ,
</span></span><span style=display:flex><span><span style=color:#f92672>+</span>	<span style=color:#ae81ff>81</span>      , <span style=color:#a6e22e>MongoDB</span>         ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>100</span>     , <span style=color:#a6e22e>Kafka</span>           ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>101</span>     , <span style=color:#a6e22e>MQTT</span>            ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>120</span>     , <span style=color:#a6e22e>DNS</span>             ,
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>127</span>     , <span style=color:#a6e22e>Custom</span>          ,
</span></span></code></pre></td></tr></table></div></div><p>到这里已经完成<code>DeepFlow Agent</code>的原生协议扩展了，参考《
<a href=https://mp.weixin.qq.com/s/-jWYq2rTRaTueuN0sAb3lA title="# 完整指南：如何编译、打包和部署二次开发的 DeepFlow" rel="noopener external nofollow noreferrer" target=_blank class=exturl># 完整指南：如何编译、打包和部署二次开发的 DeepFlow
<i class="fa fa-external-link-alt"></i>
</a>》编译程序发布即可。</p><p>如果想快速实现一个协议采集解析，或者不熟悉Rust语言呢？我们还有一个选择，就是利用Wasm插件快速扩展协议解码。</p><h2 id=利用wasm插件扩展deepflow的协议采集>利用<code>Wasm</code>插件扩展<code>DeepFlow</code>的协议采集
<a class=header-anchor href=#%e5%88%a9%e7%94%a8wasm%e6%8f%92%e4%bb%b6%e6%89%a9%e5%b1%95deepflow%e7%9a%84%e5%8d%8f%e8%ae%ae%e9%87%87%e9%9b%86></a></h2><blockquote><p>该案例是用<code>Wasm</code>扩展<code>Kafka</code>协议支持<code>Topic</code>的实践。
首先还是参考Kafka的官方文档对
<a href=https://kafka.apache.org/protocol.html title=Kafka协议 rel="noopener external nofollow noreferrer" target=_blank class=exturl>Kafka协议
<i class="fa fa-external-link-alt"></i>
</a>做一个简单的分析</p></blockquote><h3 id=kafka协议分析><code>Kafka</code>协议分析
<a class=header-anchor href=#kafka%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90></a></h3><h4 id=kafka的header和data概览><code>Kafka</code>的<code>Header</code>和<code>Data</code>概览
<a class=header-anchor href=#kafka%e7%9a%84header%e5%92%8cdata%e6%a6%82%e8%a7%88></a></h4><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/Kafka%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90.svg alt></p><h4 id=kafka的fetch-api>Kafka的Fetch API
<a class=header-anchor href=#kafka%e7%9a%84fetch-api></a></h4><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/Kafka-Fetch-ver7-11.svg alt></p><h4 id=kafka的produce-api>Kafka的Produce API
<a class=header-anchor href=#kafka%e7%9a%84produce-api></a></h4><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/Kafka-Produce-ver3-8.svg alt></p><h3 id=kafka协议deepflow-agent原生解码>Kafka协议DeepFlow Agent原生解码
<a class=header-anchor href=#kafka%e5%8d%8f%e8%ae%aedeepflow-agent%e5%8e%9f%e7%94%9f%e8%a7%a3%e7%a0%81></a></h3><blockquote><p>截止到v6.3.x版本，DeepFlow Agent对Kafka的原生解码如下图所示，还不支持Topic字段的解码，
且API的解码还没有版本号。
接下来的插件开发主要解决Topic字段的解码放在resource展示，同时把API的版本号也解析出来。</p></blockquote><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/grafana-deepflow-kafka-01.png alt></p><h3 id=deepflow-agent的-wasm-插件><code>DeepFlow Agent</code>的 <code>Wasm</code> 插件
<a class=header-anchor href=#deepflow-agent%e7%9a%84-wasm-%e6%8f%92%e4%bb%b6></a></h3><p>参考官方插件文档《
<a href=https://deepflow.io/docs/zh/integration/process/wasm-plugin/#about-wasm-plugin-system title=wasm-plugin rel="noopener external nofollow noreferrer" target=_blank class=exturl>wasm-plugin
<i class="fa fa-external-link-alt"></i>
</a>》，需要注意两点：</p><ul><li><p><code>Agent</code> 通过遍历所有支持协议判断一个流的应用层协议，顺序是：
<code>HTTP</code> -> <code>Wasm Hook</code> -> <code>DNS</code> -> &mldr;</p></li><li><p>需要使用 <code>Go</code> 版本不低于 <code>1.21</code> 并且 <code>tinygo</code> 版本需要不低于 <code>0.29</code></p></li></ul><h4 id=wasm-go-sdk-的框架>Wasm Go SDK 的框架
<a class=header-anchor href=#wasm-go-sdk-%e7%9a%84%e6%a1%86%e6%9e%b6></a></h4><ul><li>先对框架有一个大概的认识，如下代码所示，整个框架逻辑都在以下五个接口函数。</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/deepflowio/deepflow-wasm-go-sdk/sdk&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 定义结构，需要实现 sdk.Parser 接口</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>plugin</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>plugin</span>) <span style=color:#a6e22e>HookIn</span>() []<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HookBitmap</span> {<span style=color:#66d9ef>return</span> []<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HookBitmap</span>{}}
</span></span><span style=display:flex><span><span style=color:#75715e>// HookIn() 包含 HOOK_POINT_HTTP_REQ 时，http 请求解析完成返回之前会调用。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// HttpReqCtx 包含了 BaseCtx 和已经解析出来的一些 http 头部</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>plugin</span>) <span style=color:#a6e22e>OnHttpReq</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HttpReqCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HttpReqActionAbortWithResult</span>(<span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>trace</span>, <span style=color:#a6e22e>attr</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>plugin</span>) <span style=color:#a6e22e>OnHttpResp</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HttpRespCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Action</span> {<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ActionNext</span>()}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>plugin</span>) <span style=color:#a6e22e>OnCheckPayload</span>(<span style=color:#a6e22e>baseCtx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseCtx</span>) (<span style=color:#66d9ef>uint8</span>, <span style=color:#66d9ef>string</span>) {<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;ownwasm&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>plugin</span>) <span style=color:#a6e22e>OnParsePayload</span>(<span style=color:#a6e22e>baseCtx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseAction</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseActionAbortWithL7Info</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>L7ProtocolInfo</span>{})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// main 需要注册解析器</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>SetParser</span>(<span style=color:#a6e22e>plugin</span>{})
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>Agent 会遍历所有插件调用对应的 Export 函数，但是遍历的行为可以通过返回值控制</li></ul><table><thead><tr><th>返回值</th><th>说明</th></tr></thead><tbody><tr><td>sdk.ActionNext()</td><td>停止当前插件，直接执行下一个插件</td></tr><tr><td>sdk.ActionAbort()</td><td>停止当前插件并且停止遍历</td></tr><tr><td>sdk.ActionAbortWithErr(err)</td><td>停止当前插件，打印错误日志并且停止遍历</td></tr><tr><td>sdk.HttpActionAbortWithResult()</td><td>Agent 停止遍历并且提取相应返回结果</td></tr><tr><td>sdk.ParseActionAbortWithL7Info()</td><td>Agent 停止遍历并且提取相应返回结果</td></tr></tbody></table><blockquote><p>⚠️注意：
因为该案例不涉及<code>HTTP</code>协议的处理，所以<code>OnHttpReq()</code>和<code>OnHttpResp()</code>直接使用<code>sdk.ActionNext()</code> 跳过即可。
该案例也不会用到<code>sdk.HttpActionAbortWithResult()</code>。</p></blockquote><ul><li><code>HookBitmap</code>的三个 <code>hook</code> 点</li></ul><table><thead><tr><th>hook点</th><th>说明</th></tr></thead><tbody><tr><td>HOOK_POINT_HTTP_REQ</td><td>表示 http 请求解析完成返回之前</td></tr><tr><td>HOOK_POINT_HTTP_RESP</td><td>表示 http 响应解析完成返回之前</td></tr><tr><td>HOOK_POINT_PAYLOAD_PARSE</td><td>表示协议的判断和解析</td></tr></tbody></table><blockquote><p>⚠️注意：
因为该案例不涉及<code>HTTP</code>协议的处理，所以<code>HOOK_POINT_HTTP_REQ</code>和<code>HOOK_POINT_HTTP_RESP</code>在
该案例也不会用到。</p></blockquote><h4 id=插件代码指引>插件代码指引
<a class=header-anchor href=#%e6%8f%92%e4%bb%b6%e4%bb%a3%e7%a0%81%e6%8c%87%e5%bc%95></a></h4><ul><li>梳理后的<code>Kafka</code>协议的<code>Wasm</code>插件代码框架</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>  
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;github.com/deepflowio/deepflow-wasm-go-sdk/sdk&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 定义结构，需要实现 sdk.Parser 接口</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>kafkaParser</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>kafkaParser</span>) <span style=color:#a6e22e>HookIn</span>() []<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HookBitmap</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> []<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HookBitmap</span>{<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HOOK_POINT_PAYLOAD_PARSE</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// 跳过HTTP协议处理</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>kafkaParser</span>) <span style=color:#a6e22e>OnHttpReq</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HttpReqCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Action</span> {<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ActionNext</span>()}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>kafkaParser</span>) <span style=color:#a6e22e>OnHttpResp</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>HttpRespCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Action</span> {<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ActionNext</span>()}
</span></span><span style=display:flex><span><span style=color:#75715e>// 协议判断检查</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>kafkaParser</span>) <span style=color:#a6e22e>OnCheckPayload</span>(<span style=color:#a6e22e>baseCtx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseCtx</span>) (<span style=color:#66d9ef>uint8</span>, <span style=color:#66d9ef>string</span>) {<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>100</span>, <span style=color:#e6db74>&#34;kafka&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// 协议解码</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>kafkaParser</span>) <span style=color:#a6e22e>OnParsePayload</span>(<span style=color:#a6e22e>baseCtx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseAction</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseActionAbortWithL7Info</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>L7ProtocolInfo</span>{})
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// main 需要注册解析器</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>SetParser</span>(<span style=color:#a6e22e>plugin</span>{})}
</span></span></code></pre></td></tr></table></div></div><ul><li>协议识别</li></ul><blockquote><p>⚠️注意：以下代码注释</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>kafkaParser</span>) <span style=color:#a6e22e>OnCheckPayload</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseCtx</span>) (<span style=color:#66d9ef>uint8</span>, <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 跳过UDP协议数据</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>L4</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>TCP</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 如果环境有标准规范的端口约定，插件中指定端口会减少协议数据的遍历，优化解码时cpu等资源消耗</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>DstPort</span> &lt; <span style=color:#ae81ff>9092</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>DstPort</span> &gt; <span style=color:#ae81ff>9093</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 读取抓包数据</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>GetPayload</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;get payload fail: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 引用&#34;github.com/segmentio/kafka-go/protocol&#34;来解码</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>NewBytes</span>(<span style=color:#a6e22e>payload</span>))
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;read payload fail: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>decodeHeader</span>(<span style=color:#a6e22e>bl</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>WASM_KAFKA_PROTOCOL</span>, <span style=color:#e6db74>&#34;kafka&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><p>协议API解码</p><ul><li>官方代码框架<code>OnParsePayload()</code>的逻辑如下</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>plugin</span>) <span style=color:#a6e22e>OnParsePayload</span>(<span style=color:#a6e22e>baseCtx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseAction</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ctx.L7 就是 OnCheckPayload 返回的协议号，可以先根据4层协议或协议号过滤。</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>L4</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>TCP</span> {<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ActionNext</span>()}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>payload</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>GetPayload</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ActionAbortWithErr</span>(<span style=color:#a6e22e>err</span>)}
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the parse logic here</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 关于 L7ProtocolInfo 结构：
</span></span></span><span style=display:flex><span><span style=color:#75715e>            type L7ProtocolInfo struct {
</span></span></span><span style=display:flex><span><span style=color:#75715e>                ReqLen    *int       // 请求长度 例如 http 的 content-length
</span></span></span><span style=display:flex><span><span style=color:#75715e>                RespLen   *int       // 响应长度 例如 http 的 content-length
</span></span></span><span style=display:flex><span><span style=color:#75715e>                RequestID *uint32    // 子流的id标识，例如 http2 的 stream id，dns 的 transaction id
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Req       *Request
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Resp      *Response
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Trace     *Trace     // 跟踪信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Kv        []KeyVal   // 对应 attribute
</span></span></span><span style=display:flex><span><span style=color:#75715e>            }
</span></span></span><span style=display:flex><span><span style=color:#75715e>            type Request struct {
</span></span></span><span style=display:flex><span><span style=color:#75715e>                ReqType  string  // 对应请求类型
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Domain   string  // 对应请求域名
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Resource string  // 对应请求资源
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Endpoint string  // 对应 endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e>            }
</span></span></span><span style=display:flex><span><span style=color:#75715e>            type Response struct {
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Status    RespStatus // 对应响应状态
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Code      *int32     // 对应响应码
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Result    string     // 对应响应结果
</span></span></span><span style=display:flex><span><span style=color:#75715e>                Exception string     // 对应响应异常
</span></span></span><span style=display:flex><span><span style=color:#75715e>            }*/</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseActionAbortWithL7Info</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>L7ProtocolInfo</span>{})
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><ul><li>Topic字段解码的代码逻辑</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>p</span> <span style=color:#a6e22e>kafkaParser</span>) <span style=color:#a6e22e>OnParsePayload</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseCtx</span>) <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// the parse logic here</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 解码 header base size :</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// req_len(int32) + api_key(int16) + api_ver(int16) + c_id(int32) + client_len(int16)</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// = 14</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>header_offset</span> = <span style=color:#ae81ff>14</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>clientLen</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>topic_size</span> <span style=color:#66d9ef>int16</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>topic_name</span> = <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>ApiKey</span>(<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>apikey</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Produce</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>topic_size</span>, <span style=color:#a6e22e>topic_name</span> = <span style=color:#a6e22e>decodeProduce</span>(<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>apiversion</span>, <span style=color:#a6e22e>payload</span>[<span style=color:#a6e22e>header_offset</span>:])
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>Fetch</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>topic_size</span>, <span style=color:#a6e22e>topic_name</span> = <span style=color:#a6e22e>decodeFetch</span>(<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>apiversion</span>, <span style=color:#a6e22e>payload</span>[<span style=color:#a6e22e>header_offset</span>:])
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>topic_size</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ActionNext</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>req</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>Request</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ReqType</span>:  <span style=color:#a6e22e>protocol</span>.<span style=color:#a6e22e>ApiKey</span>(<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>apikey</span>).<span style=color:#a6e22e>String</span>() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;_v&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Itoa</span>(int(<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>apiversion</span>)),
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Resource</span>: <span style=color:#a6e22e>topic_name</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>ParseActionAbortWithL7Info</span>([]<span style=color:#f92672>*</span><span style=color:#a6e22e>sdk</span>.<span style=color:#a6e22e>L7ProtocolInfo</span>{
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>RequestID</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ReqLen</span>:    <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>length</span>,
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Req</span>:       <span style=color:#a6e22e>req</span>,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=加载插件和效果展示>加载插件和效果展示
<a class=header-anchor href=#%e5%8a%a0%e8%bd%bd%e6%8f%92%e4%bb%b6%e5%92%8c%e6%95%88%e6%9e%9c%e5%b1%95%e7%a4%ba></a></h4><p>执行如下命令编译插件，通过CTL方式加载插件</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-zsh data-lang=zsh><span style=display:flex><span>➜ deepflow-plugin git:<span style=color:#f92672>(</span>main<span style=color:#f92672>)</span> ✗ tinygo build -o build/topic.wasm  -target wasi  -panic<span style=color:#f92672>=</span>trap -scheduler<span style=color:#f92672>=</span>none -no-debug ./wasm/kafka/topic.go
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>➜ deepflow-plugin git:<span style=color:#f92672>(</span>main<span style=color:#f92672>)</span> ✗ deepflow-ctl plugin create --type wasm --image build/topic.wasm --name topic
</span></span></code></pre></td></tr></table></div></div><p>准备好<code>Agent</code>的配置文件增加如下配置。注意，<code>Agent</code>可以加载多个 <code>Wasm</code> 插件。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#75715e>############</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>## plugin ##</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>############</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>## wasm plugin need to load in agent</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>wasm-plugins</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>mongo</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>topic</span>
</span></span></code></pre></td></tr></table></div></div><p>执行命令更新配置</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>➜ deepflow-plugin git:<span style=color:#f92672>(</span>main<span style=color:#f92672>)</span> ✗ deepflow-ctl agent-group-config update -f g-d2d06af17e.yaml
</span></span></code></pre></td></tr></table></div></div><p>当<code>Agent</code>日志出现如下图黄字体内容，即加载成功。
<img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/deepflow-wasm-kafka-01.png alt></p><p>在<code>Grafana</code>上，可以看到原生的<code>Kafka</code>协议被覆盖，出现了几个变化：</p><ul><li><code>Protocol</code> 字段从<code>Kafka</code> 变成 <code>Custom</code></li><li><code>Request type</code>字段的<code>API</code>多了版本号</li><li><code>Request resource</code>字段出现了<code>Topic</code>信息
<img src=/imgs/img-lazy-loading.gif data-src=/posts/ebpf/images/grafana-deepflow-kafka-02.png alt></li></ul><h2 id=结语>结语
<a class=header-anchor href=#%e7%bb%93%e8%af%ad></a></h2><blockquote><p>最后对比一下两个协议扩展的方式，要注意⚠️的是：
两者都存在一个共性问题，就是每增加一个协议，识别协议解码的效率相对降低，
可以通过配置的方式减少需解码的协议数量</p></blockquote><h3 id=原生rust扩展>原生Rust扩展
<a class=header-anchor href=#%e5%8e%9f%e7%94%9frust%e6%89%a9%e5%b1%95></a></h3><ul><li><p>优点：</p><ul><li>运行时的资源占用比插件低</li><li>支持的功能比插件的丰富，且定制性更灵活</li></ul></li><li><p>缺点：</p><ul><li>在语言方面的开发难度比插件的大</li><li>相对插件开发而言，新增协议需要改动的地方较多，还涉及到Server的一小部分代码</li></ul></li></ul><h3 id=wasm插件扩展>Wasm插件扩展
<a class=header-anchor href=#wasm%e6%8f%92%e4%bb%b6%e6%89%a9%e5%b1%95></a></h3><ul><li><p>优点：</p><ul><li>用Golang开发相对Rust语言难度较低</li><li>可在运行时通过CLI方式加载</li><li>扩展性强</li></ul></li><li><p>缺点：</p><ul><li>Go 的标准库和第三方库有一定的限制，且调试难度大，导致插件异常较难排除</li><li>由于Wasm本身限制等问题，导致功能相对Rust原生开发较弱</li><li>资源增加，特别是内存方面。</li></ul></li></ul><h2 id=附录>附录
<a class=header-anchor href=#%e9%99%84%e5%bd%95></a></h2><ul><li><a href=https://github.com/deepflowio/deepflow/blob/main/docs/HOW_TO_SUPPORT_YOUR_PROTOCOL_CN.MD title="DeepFlow 协议开发文档" rel="noopener external nofollow noreferrer" target=_blank class=exturl>DeepFlow 协议开发文档
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://deepflow.io/docs/zh/integration/process/wasm-plugin/#about-wasm-plugin-system title="DeepFlow的Wasm 插件系统" rel="noopener external nofollow noreferrer" target=_blank class=exturl>DeepFlow的Wasm 插件系统
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://deepflow.io/blog/035-deepflow-enabling-zero-code-observability-for-applications-by-webAssembly/ title="使用 DeepFlow Wasm 插件实现业务可观测性" rel="noopener external nofollow noreferrer" target=_blank class=exturl>使用 DeepFlow Wasm 插件实现业务可观测性
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/ title=MongoDB协议文档 rel="noopener external nofollow noreferrer" target=_blank class=exturl>MongoDB协议文档
<i class="fa fa-external-link-alt"></i></a></li><li><a href=https://kafka.apache.org/protocol.html title=Kafka协议文档 rel="noopener external nofollow noreferrer" target=_blank class=exturl>Kafka协议文档
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/tcp>Tcp
</a><a href=/tags/deepflow>DeepFlow
</a><a href=/tags/ebpf>eBPF</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>
赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/ali-pay.png alt="蓝宝石的傻话 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/imgs/wechat-pay.png alt="蓝宝石的傻话 - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）</li><li class=post-copyright-author><strong>本文作者： </strong>蓝宝石的傻话</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/posts/ebpf/deepflow-agent-proto-dev/ title="eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）">/posts/ebpf/deepflow-agent-proto-dev/</a></li><li class=post-copyright-license><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i>
</span><span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/posts/iot/esp-01-dht11/ rel=next title="基于 ESP01 主板的温湿度监控开发"><i class="fa fa-chevron-left"></i> 基于 ESP01 主板的温湿度监控开发</a></div><div class="post-nav-prev post-nav-item"><a href=/posts/opentelemetry/stream-metrics-one/ rel=prev title=VictoriaMetrics的指标流聚合能力应用>VictoriaMetrics的指标流聚合能力应用
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>蓝宝石的傻话</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.151.2 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备2023145803号</a>
<img src=/imgs/gongan.png alt=粤公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011102001194" target=_blank>粤公网安备 44011102001194 号</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.31dafd2443e6bcd4e91b9f755e3281cdf4524d7d753bc4fe66b7e7be0928eeae.js defer></script></body></html>