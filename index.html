<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.145.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/x-icon href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/favicon.png><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."><meta itemprop=image content="/imgs/icons/custom.png"><meta itemprop=keywords content="MickeyBee,MickeyZZC,可观测性,Sre,运维,eBPF"><meta property="og:type" content="website"><meta property="og:title" content="蓝宝石的傻话"><meta property="og:description" content="What is rational is real; and what is real is rational."><meta property="og:image" content="/imgs/icons/custom.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/"><meta property="og:site_name" content="蓝宝石的傻话"><meta property="og:locale" content="zh-CN"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.374a99719ba5f425af97e9e4d4b002d4efa1a29ac3be3b0cb855d613bc1fbddf.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":true,"isPage":false,"path":"/","permalink":"/","title":"蓝宝石的傻话","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>蓝宝石的傻话</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>蓝宝石的傻话</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>MickeyBee's BLOG</p><img class=custom-logo-image src=/imgs/icons/custom.png alt=蓝宝石的傻话></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class="hvr-icon-pulse menu-item-active" rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>14</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=蓝宝石的傻话 src=/imgs/img-lazy-loading.gif data-src=/imgs/avatar.jpeg><p class=site-author-name itemprop=name>蓝宝石的傻话</p><div class=site-description itemprop=description>What is rational is real; and what is real is rational.</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>14</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>10</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>13</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/mickeyzzc title="Github → https://github.com/mickeyzzc" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=https://gitee.com/mickeybee title="Gitee → https://gitee.com/mickeybee" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Gitee
</a></span><span class=links-of-social-item><a href=mailto:mickey_zzc@163.com title="E-Mail → mailto:mickey_zzc@163.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://blog.51cto.com/mickeyzzc title=https://blog.51cto.com/mickeyzzc target=_blank>我的51cto博客</a></li><li class=links-of-blogroll-item><a href=https://deepflow.io/ title=https://deepflow.io/ target=_blank>DeepFlow</a></li><li class=links-of-blogroll-item><a href=https://blog.csdn.net/mickey_zzc title=https://blog.csdn.net/mickey_zzc target=_blank>CSDN博客</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=2016-08-11T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=31220></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=68></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-11-25T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/mickeyzzc rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg>
</a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script><script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner index posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/ebpf/deepflow-agent-proto-dev/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）"><meta itemprop=description content="


    概述：
    



    如何分析一个协议(MongoDB)
    




    协议文档的分析思路
    



    MongoDB协议操作码说明表
    



    对最常见的操作码OP_MSG分析
    





    在DeepFlow Agent扩展一个协议解析采集
    




    DeepFlow Agent的开发文档概要
    



    代码指引
    




    定义一个协议，并用一个常量标识。
    



    为新协议准备解析逻辑
    




    定义结构体
    



    实现 L7ProtocolParserInterface
    









    利用Wasm插件扩展DeepFlow的协议采集
    




    Kafka协议分析
    




    Kafka的Header和Data概览
    



    Kafka的Fetch API
    



    Kafka的Produce API
    





    Kafka协议DeepFlow Agent原生解码
    



    DeepFlow Agent的 Wasm 插件
    




    Wasm Go SDK 的框架
    



    插件代码指引
    







    结语
    




    原生Rust扩展
    



    Wasm插件扩展
    





    附录
    





概述：

MongoDB 目前使用广泛，但是缺乏有效的可观测能力。
DeepFlow 在可观测能力上是很优秀的解决方案，但是却缺少了对 MongoDB 协议的支持。
该文是为 DeepFlow 扩展了 MongoDB 协议解析，增强 MongoDB 生态的可观测能力，简要描述了从协议文档分析到在 DeepFlow 内实现代码解析的过程拆解。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/ebpf/deepflow-agent-proto-dev/ itemprop=url class=post-title-link>eBPF系列之：DeepFlow 扩展协议解析实践（MongoDB协议与Kafka协议）</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-11-25 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-11-25 00:00:00 +0000 UTC">2023-11-25
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/ebpf itemprop=url rel=index><span itemprop=name>eBPF</span></a></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><ul><li><a href=#%e6%a6%82%e8%bf%b0 title=概述：>概述：</a></li><li><a href=#%e5%a6%82%e4%bd%95%e5%88%86%e6%9e%90%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%aemongodb title=如何分析一个协议(MongoDB)>如何分析一个协议(MongoDB)</a><ul><li><a href=#%e5%8d%8f%e8%ae%ae%e6%96%87%e6%a1%a3%e7%9a%84%e5%88%86%e6%9e%90%e6%80%9d%e8%b7%af title=协议文档的分析思路>协议文档的分析思路</a></li><li><a href=#mongodb%e5%8d%8f%e8%ae%ae%e6%93%8d%e4%bd%9c%e7%a0%81%e8%af%b4%e6%98%8e%e8%a1%a8 title=MongoDB协议操作码说明表>MongoDB协议操作码说明表</a></li><li><a href=#%e5%af%b9%e6%9c%80%e5%b8%b8%e8%a7%81%e7%9a%84%e6%93%8d%e4%bd%9c%e7%a0%81op_msg%e5%88%86%e6%9e%90 title=对最常见的操作码OP_MSG分析>对最常见的操作码<code>OP_MSG</code>分析</a></li></ul></li><li><a href=#%e5%9c%a8deepflow-agent%e6%89%a9%e5%b1%95%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%ae%e8%a7%a3%e6%9e%90%e9%87%87%e9%9b%86 title="在DeepFlow Agent扩展一个协议解析采集">在<code>DeepFlow Agent</code>扩展一个协议解析采集</a><ul><li><a href=#deepflow-agent%e7%9a%84%e5%bc%80%e5%8f%91%e6%96%87%e6%a1%a3%e6%a6%82%e8%a6%81 title="DeepFlow Agent的开发文档概要"><code>DeepFlow Agent</code>的开发文档概要</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e6%8c%87%e5%bc%95 title=代码指引>代码指引</a><ul><li><a href=#%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aa%e5%8d%8f%e8%ae%ae%e5%b9%b6%e7%94%a8%e4%b8%80%e4%b8%aa%e5%b8%b8%e9%87%8f%e6%a0%87%e8%af%86 title=定义一个协议，并用一个常量标识。>定义一个协议，并用一个常量标识。</a></li><li><a href=#%e4%b8%ba%e6%96%b0%e5%8d%8f%e8%ae%ae%e5%87%86%e5%a4%87%e8%a7%a3%e6%9e%90%e9%80%bb%e8%be%91 title=为新协议准备解析逻辑>为新协议准备解析逻辑</a><ul><li><a href=#%e5%ae%9a%e4%b9%89%e7%bb%93%e6%9e%84%e4%bd%93 title=定义结构体>定义结构体</a></li><li><a href=#%e5%ae%9e%e7%8e%b0l7protocolparserinterface title=实现 L7ProtocolParserInterface>实现 <code>L7ProtocolParserInterface</code></a></li></ul></li></ul></li></ul></li><li><a href=#%e5%88%a9%e7%94%a8wasm%e6%8f%92%e4%bb%b6%e6%89%a9%e5%b1%95deepflow%e7%9a%84%e5%8d%8f%e8%ae%ae%e9%87%87%e9%9b%86 title=利用Wasm插件扩展DeepFlow的协议采集>利用<code>Wasm</code>插件扩展<code>DeepFlow</code>的协议采集</a><ul><li><a href=#kafka%e5%8d%8f%e8%ae%ae%e5%88%86%e6%9e%90 title=Kafka协议分析><code>Kafka</code>协议分析</a><ul><li><a href=#kafka%e7%9a%84header%e5%92%8cdata%e6%a6%82%e8%a7%88 title=Kafka的Header和Data概览><code>Kafka</code>的<code>Header</code>和<code>Data</code>概览</a></li><li><a href=#kafka%e7%9a%84fetch-api title="Kafka的Fetch API">Kafka的Fetch API</a></li><li><a href=#kafka%e7%9a%84produce-api title="Kafka的Produce API">Kafka的Produce API</a></li></ul></li><li><a href=#kafka%e5%8d%8f%e8%ae%aedeepflow-agent%e5%8e%9f%e7%94%9f%e8%a7%a3%e7%a0%81 title="Kafka协议DeepFlow Agent原生解码">Kafka协议DeepFlow Agent原生解码</a></li><li><a href=#deepflow-agent%e7%9a%84-wasm-%e6%8f%92%e4%bb%b6 title="DeepFlow Agent的 Wasm 插件"><code>DeepFlow Agent</code>的 <code>Wasm</code> 插件</a><ul><li><a href=#wasm-go-sdk-%e7%9a%84%e6%a1%86%e6%9e%b6 title="Wasm Go SDK 的框架">Wasm Go SDK 的框架</a></li><li><a href=#%e6%8f%92%e4%bb%b6%e4%bb%a3%e7%a0%81%e6%8c%87%e5%bc%95 title=插件代码指引>插件代码指引</a></li></ul></li></ul></li><li><a href=#%e7%bb%93%e8%af%ad title=结语>结语</a><ul><li><a href=#%e5%8e%9f%e7%94%9frust%e6%89%a9%e5%b1%95 title=原生Rust扩展>原生Rust扩展</a></li><li><a href=#wasm%e6%8f%92%e4%bb%b6%e6%89%a9%e5%b1%95 title=Wasm插件扩展>Wasm插件扩展</a></li></ul></li><li><a href=#%e9%99%84%e5%bd%95 title=附录>附录</a></li></ul><div style=position:relative;padding-bottom:75%;width:100%;height:0><iframe src="//player.bilibili.com/player.html?isOutside=true&aid=921401645&bvid=BV1Nu4y1A7ZC&cid=1345829549&p=1" scrolling=no border=0 frameborder=no framespacing=0 allowfullscreen style=position:absolute;height:100%;width:100%></iframe></div><h2 id=概述>概述：
<a class=header-anchor href=#%e6%a6%82%e8%bf%b0></a></h2><p><code>MongoDB</code> 目前使用广泛，但是缺乏有效的可观测能力。
<code>DeepFlow</code> 在可观测能力上是很优秀的解决方案，但是却缺少了对 <code>MongoDB</code> 协议的支持。
该文是为 <code>DeepFlow</code> 扩展了 <code>MongoDB</code> 协议解析，增强 <code>MongoDB</code> 生态的可观测能力，简要描述了从协议文档分析到在 <code>DeepFlow</code> 内实现代码解析的过程拆解。</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/ebpf/deepflow-agent-proto-dev/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/stream-metrics-one/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="VictoriaMetrics的指标流聚合能力应用"><meta itemprop=description content="社区VM对指标流聚合能力分析与问题

VictoriaMetrics开源项目的原生能力

VictoriaMetrics项目中的流聚合能力是从1.86版本开始整合到vmagent的，具体可参考： 

    https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460
    
    
    

从源码分析来看，流集合能力如图："></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/opentelemetry/stream-metrics-one/ itemprop=url class=post-title-link>VictoriaMetrics的指标流聚合能力应用</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-03-27 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-03-27 00:00:00 +0000 UTC">2023-03-27
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/victoriametrics itemprop=url rel=index><span itemprop=name>Prometheus/VictoriaMetrics</span></a></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=社区vm对指标流聚合能力分析与问题>社区VM对指标流聚合能力分析与问题
<a class=header-anchor href=#%e7%a4%be%e5%8c%bavm%e5%af%b9%e6%8c%87%e6%a0%87%e6%b5%81%e8%81%9a%e5%90%88%e8%83%bd%e5%8a%9b%e5%88%86%e6%9e%90%e4%b8%8e%e9%97%ae%e9%a2%98></a></h2><h3 id=victoriametrics开源项目的原生能力>VictoriaMetrics开源项目的原生能力
<a class=header-anchor href=#victoriametrics%e5%bc%80%e6%ba%90%e9%a1%b9%e7%9b%ae%e7%9a%84%e5%8e%9f%e7%94%9f%e8%83%bd%e5%8a%9b></a></h3><p>VictoriaMetrics项目中的流聚合能力是从1.86版本开始整合到vmagent的，具体可参考：
<a href=https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460 title=https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://github.com/VictoriaMetrics/VictoriaMetrics/issues/3460
<i class="fa fa-external-link-alt"></i>
</a>从源码分析来看，流集合能力如图：</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/opentelemetry/stream-metrics-one/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/ebpf/pixie-try/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="eBPF系列之：Pixie浅剖析"><meta itemprop=description content="部署过程和指令参考：

    pixie install
    
    
    

Pixie平台主要由以下组件组成：



Pixie Edge Module 边缘模块(PEM):
Pixie&rsquo;s agent, installed per node. PEMs use eBPF to collect data, which is stored locally on the node.
Pixie的代理，安装在每个节点上。PEM使用eBPF收集数据，这些数据存储在节点本地。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/ebpf/pixie-try/ itemprop=url class=post-title-link>eBPF系列之：Pixie浅剖析</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-02-10 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-02-10 00:00:00 +0000 UTC">2023-02-10
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/ebpf itemprop=url rel=index><span itemprop=name>eBPF</span></a></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p>部署过程和指令参考：
<a href=https://docs.px.dev/installing-pixie/install-guides/self-hosted-pixie/ title="pixie install" rel="noopener external nofollow noreferrer" target=_blank class=exturl>pixie install
<i class="fa fa-external-link-alt"></i></a></p><h2 id=pixie平台主要由以下组件组成>Pixie平台主要由以下组件组成：
<a class=header-anchor href=#pixie%e5%b9%b3%e5%8f%b0%e4%b8%bb%e8%a6%81%e7%94%b1%e4%bb%a5%e4%b8%8b%e7%bb%84%e4%bb%b6%e7%bb%84%e6%88%90></a></h2><ul><li><p><strong>Pixie Edge Module 边缘模块(PEM)</strong>:
Pixie&rsquo;s agent, installed per node. PEMs use eBPF to collect data, which is stored locally on the node.
Pixie的代理，安装在每个节点上。PEM使用eBPF收集数据，这些数据存储在节点本地。</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/ebpf/pixie-try/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/talk-about-cpu-timer/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="闲聊一下CPU时序和现代操作系统二三事"><meta itemprop=description content="时分系统和Linux

首先我们补习一下时分系统，时分系统是一个非常重要的操作系统概念,它最大限度地提高了运算机的利用率,是实现多道程序并发执行的重要手段。
我们日常工作用到的Linux系统 内核也采用了时分系统的思想,主要体现在以下几个方面:"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/opentelemetry/talk-about-cpu-timer/ itemprop=url class=post-title-link>闲聊一下CPU时序和现代操作系统二三事</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2023-01-20 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2023-01-20 00:00:00 +0000 UTC">2023-01-20
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/cpu itemprop=url rel=index><span itemprop=name>Linux/CPU</span></a></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=时分系统和linux>时分系统和Linux
<a class=header-anchor href=#%e6%97%b6%e5%88%86%e7%b3%bb%e7%bb%9f%e5%92%8clinux></a></h2><p>首先我们补习一下时分系统，时分系统是一个非常重要的操作系统概念,它最大限度地提高了运算机的利用率,是实现多道程序并发执行的重要手段。
我们日常工作用到的Linux系统 内核也采用了时分系统的思想,主要体现在以下几个方面:</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/opentelemetry/talk-about-cpu-timer/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/prometheus-evolution-history-three/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="监控系统企业架构演进史-拨测监控"><meta itemprop=description content="前情概述：

在《监控系统企业架构演进史-跨地域混合云》中，监控系统已经逐步成熟且企业化发展。
这一章节简单讲述一下期间的拨测能力搭建，以下是这套系统的发展史，在监控平台搭建的过程中，内部监控采集还不足以满足企业业务需求，在计划发展apm之前，异地拨测的黑匣子监控也纳入了该系统的一个子功能。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/opentelemetry/prometheus-evolution-history-three/ itemprop=url class=post-title-link>监控系统企业架构演进史-拨测监控</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2020-12-12 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2020-12-12 00:00:00 +0000 UTC">2020-12-12</time></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=前情概述>前情概述：
<a class=header-anchor href=#%e5%89%8d%e6%83%85%e6%a6%82%e8%bf%b0></a></h2><p>在《监控系统企业架构演进史-跨地域混合云》中，监控系统已经逐步成熟且企业化发展。
这一章节简单讲述一下期间的拨测能力搭建，以下是这套系统的发展史，在监控平台搭建的过程中，内部监控采集还不足以满足企业业务需求，在计划发展apm之前，异地拨测的黑匣子监控也纳入了该系统的一个子功能。</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/opentelemetry/prometheus-evolution-history-three/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/prometheus-evolution-history-two/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="监控系统企业架构演进史-跨地域混合云"><meta itemprop=description content="前情概述：

在《监控系统企业架构演进史-初入Prometheus》中，监控系统已经从单体架构升级到单IDC分布式架构了。
前一篇文章的内容是适用于虚拟机部署和容器部署的。Prometheus是云原生时代的产物，一般和Kubernetes配套使用，但是Prometheus本身也能在非Kubernetes取替传统监控如Zabbix使用的。
在该篇文章中，开始以Kubernetes的部署来升级整个监控系统架构，使之在跨地域混合云的业务场景中更具灵活性。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/opentelemetry/prometheus-evolution-history-two/ itemprop=url class=post-title-link>监控系统企业架构演进史-跨地域混合云</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2020-10-12 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2020-10-12 00:00:00 +0000 UTC">2020-10-12</time></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=前情概述>前情概述：
<a class=header-anchor href=#%e5%89%8d%e6%83%85%e6%a6%82%e8%bf%b0></a></h2><p>在《监控系统企业架构演进史-初入Prometheus》中，监控系统已经从单体架构升级到单<code>IDC</code>分布式架构了。
前一篇文章的内容是适用于虚拟机部署和容器部署的。<code>Prometheus</code>是云原生时代的产物，一般和<code>Kubernetes</code>配套使用，但是<code>Prometheus</code>本身也能在非<code>Kubernetes</code>取替传统监控如<code>Zabbix</code>使用的。
在该篇文章中，开始以<code>Kubernetes</code>的部署来升级整个监控系统架构，使之在跨地域混合云的业务场景中更具灵活性。</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/opentelemetry/prometheus-evolution-history-two/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/opentelemetry/prometheus-evolution-history-one/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="监控系统企业架构演进史-初入Prometheus"><meta itemprop=description content="Prometheus是一个开源的监控与时间序列数据库系统,在近年来得到了越来越广泛的应用。
官方的架构图如图所示：

本系列文章会以Prometheus的在一个企业里的部署架构演进过程中逐步理解和深入各种组件和概念。
先通过下图简单了解这个演进发展史
"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/opentelemetry/prometheus-evolution-history-one/ itemprop=url class=post-title-link>监控系统企业架构演进史-初入Prometheus</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2019-12-12 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2019-12-12 00:00:00 +0000 UTC">2019-12-12</time></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p><code>Prometheus</code>是一个开源的监控与时间序列数据库系统,在近年来得到了越来越广泛的应用。
官方的架构图如图所示：
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/prometheus-architecture.svg alt>
本系列文章会以<code>Prometheus</code>的在一个企业里的部署架构演进过程中逐步理解和深入各种组件和概念。
先通过下图简单了解这个演进发展史
<img src=/imgs/img-lazy-loading.gif data-src=/posts/opentelemetry/images/monitoring-system-2019-2020.png alt></p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/opentelemetry/prometheus-evolution-history-one/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/old/linode-bbr-test/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Linode的BBR简单测试"><meta itemprop=description content='概述:


TCP BBR 致力于解决两个问题：

在有一定丢包率的网络链路上充分利用带宽。非常适合高延迟、高带宽的网络链路。
降低网络链路上的 buffer 占用率，从而降低延迟。非常适合慢速接入网络的用户。


测试目的:
这次的测试主要是针对丢包率.更有说服力的测试请参考

    Lawrence Brakmo的BBR Report
    
    
    
.


    BBR的另一面
    
    
    


测试准备：


ADDR01：aaa.aaa.aaa.aaa



1
2


$ uname -r
4.8.6-x86_64-linode78



ADDR02：bbb.bbb.bbb.bbb



1
2


# uname -r
4.8.6-x86_64-linode78



测试方式：


模拟丢包1%-30%的场景，分别测试不同内核开启BBR先后的情况。
用到的tc指令：



1
2
3
4
5
6
7
8


# 清理tc规则：
tc qdisc del root dev eth0
# 模拟1%丢包：
tc qdisc add dev eth0 root netem loss 1%
# 模拟10%丢包：
tc qdisc add dev eth0 root netem loss 10%
# 模拟30%丢包：
tc qdisc add dev eth0 root netem loss 30%



测试从从ADDR02传数据到ADDR01,ADDR01的内核不变,ADDR02在每次测试都会调整内核重启。

测试过程：


步骤略,test.gz约160MB,过程大致如下:
没有启用BBR的情况，从ADDR02传数据到ADDR01：



1
2
3
4
5
6


$ rsync -ave "ssh -l mickey"  --progress test.gz mickey@bbb.bbb.bbb.bbb:/home/mickey/test.gz
sending incremental file list
test.gz
   166042909 100%    3.27MB/s    0:00:48 (xfer#1, to-check=0/1)
sent 166063274 bytes  received 31 bytes  3288382.28 bytes/sec
total size is 166042909  speedup is 1.00




测试数据比对:




  
      
          
          4.8.6-x86_64-linode78
          4.9.15-x86_64-linode78
          非linode的官方4.10内核(generic)
      
  
  
      
          没有启动BBR正常情况
          3.27MB/s
          3.36MB/s
          没有测试
      
      
          启动BBR正常情况
          没有测试
          3.45MB/s
          2.31MB/s
      
      
          启动BBR丢包1%
          3.19MB/s
          没有测试
          没有测试
      
      
          启动BBR丢包10%
          没有测试
          3.21MB/s
          2.81MB/s
      
      
          启动BBR丢包30%
          97.30kB/s(在20分钟内没有传输完成中断得到的最后结果)
          1.35MB/s
          1.15MB/s
      
  



测试总结和当时情况(以上述结果来总结):


linode自己编译的内核有明显针对性优化,效果比较明显.
启动bbr后在丢包30%的情况下还能完成传输,bbr的效果也比较明显;
4.10内核选择了generic没有选择lowlatency.
本来还打算测50%的丢包.但是50%设置后几乎无法远程操作ADDR01而放弃测试.




附录：


centos7官方内核的升级方法：

升级内核:





1
2
3


rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
yum --enablerepo=elrepo-kernel install kernel-ml -y



更新启动



1
2
3


egrep ^menuentry /etc/grub2.cfg | cut -f 2 -d \&#39;
grub2-set-default 0  #default 0表示第一个内核设置为默认运行, 选择最新内核就对了
reboot



开启BBR：



1
2
3
4


modprobe tcp_bbr
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p


'></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/old/linode-bbr-test/ itemprop=url class=post-title-link>Linode的BBR简单测试</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2017-04-10 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2017-04-10 00:00:00 +0000 UTC">2017-04-10
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/tcp itemprop=url rel=index><span itemprop=name>Tcp</span></a></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=概述>概述:
<a class=header-anchor href=#%e6%a6%82%e8%bf%b0></a></h2><ul><li>TCP BBR 致力于解决两个问题：<ul><li>在有一定丢包率的网络链路上充分利用带宽。非常适合高延迟、高带宽的网络链路。</li><li>降低网络链路上的 buffer 占用率，从而降低延迟。非常适合慢速接入网络的用户。</li></ul></li><li>测试目的:
这次的测试主要是针对丢包率.更有说服力的测试请参考
<a href=https://drive.google.com/file/d/0B4YZ_0yTgbJEa21CbUVLWFdrX2c/view title="Lawrence Brakmo的BBR Report" rel="noopener external nofollow noreferrer" target=_blank class=exturl>Lawrence Brakmo的BBR Report
<i class="fa fa-external-link-alt"></i>
</a>.</li><li><a href=http://blog.csdn.net/dog250/article/details/54754784 title=BBR的另一面 rel="noopener external nofollow noreferrer" target=_blank class=exturl>BBR的另一面
<i class="fa fa-external-link-alt"></i></a></li></ul><h2 id=测试准备>测试准备：
<a class=header-anchor href=#%e6%b5%8b%e8%af%95%e5%87%86%e5%a4%87></a></h2><ul><li>ADDR01：aaa.aaa.aaa.aaa</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ uname -r
</span></span><span style=display:flex><span>4.8.6-x86_64-linode78
</span></span></code></pre></td></tr></table></div></div><ul><li>ADDR02：bbb.bbb.bbb.bbb</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># uname -r</span>
</span></span><span style=display:flex><span>4.8.6-x86_64-linode78
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=测试方式>测试方式：
<a class=header-anchor href=#%e6%b5%8b%e8%af%95%e6%96%b9%e5%bc%8f></a></h2><ul><li>模拟丢包1%-30%的场景，分别测试不同内核开启BBR先后的情况。
用到的tc指令：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#75715e># 清理tc规则：</span>
</span></span><span style=display:flex><span>tc qdisc del root dev eth0
</span></span><span style=display:flex><span><span style=color:#75715e># 模拟1%丢包：</span>
</span></span><span style=display:flex><span>tc qdisc add dev eth0 root netem loss 1%
</span></span><span style=display:flex><span><span style=color:#75715e># 模拟10%丢包：</span>
</span></span><span style=display:flex><span>tc qdisc add dev eth0 root netem loss 10%
</span></span><span style=display:flex><span><span style=color:#75715e># 模拟30%丢包：</span>
</span></span><span style=display:flex><span>tc qdisc add dev eth0 root netem loss 30%
</span></span></code></pre></td></tr></table></div></div><ul><li>测试从从ADDR02传数据到ADDR01,ADDR01的内核不变,ADDR02在每次测试都会调整内核重启。</li></ul><h2 id=测试过程>测试过程：
<a class=header-anchor href=#%e6%b5%8b%e8%af%95%e8%bf%87%e7%a8%8b></a></h2><ul><li>步骤略,test.gz约160MB,过程大致如下:
没有启用BBR的情况，从ADDR02传数据到ADDR01：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>$ rsync -ave <span style=color:#e6db74>&#34;ssh -l mickey&#34;</span>  --progress test.gz mickey@bbb.bbb.bbb.bbb:/home/mickey/test.gz
</span></span><span style=display:flex><span>sending incremental file list
</span></span><span style=display:flex><span>test.gz
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>166042909</span> 100%    3.27MB/s    0:00:48 <span style=color:#f92672>(</span>xfer#1, to-check<span style=color:#f92672>=</span>0/1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>sent <span style=color:#ae81ff>166063274</span> bytes  received <span style=color:#ae81ff>31</span> bytes  3288382.28 bytes/sec
</span></span><span style=display:flex><span>total size is <span style=color:#ae81ff>166042909</span>  speedup is 1.00
</span></span></code></pre></td></tr></table></div></div><ul><li><h2 id=测试数据比对>测试数据比对:
<a class=header-anchor href=#%e6%b5%8b%e8%af%95%e6%95%b0%e6%8d%ae%e6%af%94%e5%af%b9></a></h2></li></ul><table><thead><tr><th style=text-align:center></th><th style=text-align:center>4.8.6-x86_64-linode78</th><th style=text-align:center>4.9.15-x86_64-linode78</th><th style=text-align:center>非linode的官方4.10内核(generic)</th></tr></thead><tbody><tr><td style=text-align:center>没有启动BBR正常情况</td><td style=text-align:center>3.27MB/s</td><td style=text-align:center>3.36MB/s</td><td style=text-align:center>没有测试</td></tr><tr><td style=text-align:center>启动BBR正常情况</td><td style=text-align:center>没有测试</td><td style=text-align:center>3.45MB/s</td><td style=text-align:center>2.31MB/s</td></tr><tr><td style=text-align:center>启动BBR丢包1%</td><td style=text-align:center>3.19MB/s</td><td style=text-align:center>没有测试</td><td style=text-align:center>没有测试</td></tr><tr><td style=text-align:center>启动BBR丢包10%</td><td style=text-align:center>没有测试</td><td style=text-align:center>3.21MB/s</td><td style=text-align:center>2.81MB/s</td></tr><tr><td style=text-align:center>启动BBR丢包30%</td><td style=text-align:center>97.30kB/s(在20分钟内没有传输完成中断得到的最后结果)</td><td style=text-align:center>1.35MB/s</td><td style=text-align:center>1.15MB/s</td></tr></tbody></table><ul><li><h3 id=测试总结和当时情况以上述结果来总结>测试总结和当时情况(以上述结果来总结):
<a class=header-anchor href=#%e6%b5%8b%e8%af%95%e6%80%bb%e7%bb%93%e5%92%8c%e5%bd%93%e6%97%b6%e6%83%85%e5%86%b5%e4%bb%a5%e4%b8%8a%e8%bf%b0%e7%bb%93%e6%9e%9c%e6%9d%a5%e6%80%bb%e7%bb%93></a></h3><ul><li>linode自己编译的内核有明显针对性优化,效果比较明显.</li><li>启动bbr后在丢包30%的情况下还能完成传输,bbr的效果也比较明显;</li><li>4.10内核选择了generic没有选择lowlatency.</li><li>本来还打算测50%的丢包.但是50%设置后几乎无法远程操作ADDR01而放弃测试.</li></ul></li></ul><hr><h2 id=附录>附录：
<a class=header-anchor href=#%e9%99%84%e5%bd%95></a></h2><ul><li>centos7官方内核的升级方法：<ul><li>升级内核:</li></ul></li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
</span></span><span style=display:flex><span>rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
</span></span><span style=display:flex><span>yum --enablerepo<span style=color:#f92672>=</span>elrepo-kernel install kernel-ml -y
</span></span></code></pre></td></tr></table></div></div><ul><li>更新启动</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>egrep ^menuentry /etc/grub2.cfg | cut -f <span style=color:#ae81ff>2</span> -d <span style=color:#ae81ff>\&#39;</span>
</span></span><span style=display:flex><span>grub2-set-default <span style=color:#ae81ff>0</span>  <span style=color:#75715e>#default 0表示第一个内核设置为默认运行, 选择最新内核就对了</span>
</span></span><span style=display:flex><span>reboot
</span></span></code></pre></td></tr></table></div></div><ul><li>开启BBR：</li></ul><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span>modprobe tcp_bbr
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;net.core.default_qdisc=fq&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;net.ipv4.tcp_congestion_control=bbr&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span>sysctl -p
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/old/linode-bbr-test/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/old/rasp_pi_docker/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="树莓派 RaspberryPi docker集群"><meta itemprop=description content="概述：

参考

    Hypriot
    
    
    
的博客，我买了1块Rasp2代板和2块Rasp3代板。

其中2代默认安装了

    Hypriot
    
    
    
的系统。3代板如果您有兴趣可以自己参考

    《Building a 64bit Docker OS for the Raspberry Pi 3》
    
    
    
这篇文章编译一套64bit的系统。也可以直接下载作者的

    已编译好镜像地址
    
    
    
中压缩包。"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/old/rasp_pi_docker/ itemprop=url class=post-title-link>树莓派 RaspberryPi docker集群</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2017-03-08 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2017-03-08 00:00:00 +0000 UTC">2017-03-08
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/docker itemprop=url rel=index><span itemprop=name>Docker</span></a></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=概述>概述：
<a class=header-anchor href=#%e6%a6%82%e8%bf%b0></a></h2><p>参考
<a href=http://blog.hypriot.com/ title=Hypriot rel="noopener external nofollow noreferrer" target=_blank class=exturl>Hypriot
<i class="fa fa-external-link-alt"></i>
</a>的博客，我买了1块Rasp2代板和2块Rasp3代板。</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/old/images/RaspPi_cluster_withLine.jpg alt></p><p>其中2代默认安装了
<a href=http://blog.hypriot.com/ title=Hypriot rel="noopener external nofollow noreferrer" target=_blank class=exturl>Hypriot
<i class="fa fa-external-link-alt"></i>
</a>的系统。3代板如果您有兴趣可以自己参考
<a href=http://blog.hypriot.com/post/building-a-64bit-docker-os-for-rpi3/ title="《Building a 64bit Docker OS for the Raspberry Pi 3》" rel="noopener external nofollow noreferrer" target=_blank class=exturl>《Building a 64bit Docker OS for the Raspberry Pi 3》
<i class="fa fa-external-link-alt"></i>
</a>这篇文章编译一套64bit的系统。也可以直接下载作者的
<a href=https://github.com/DieterReuter/image-builder-rpi64/releases title=已编译好镜像地址 rel="noopener external nofollow noreferrer" target=_blank class=exturl>已编译好镜像地址
<i class="fa fa-external-link-alt"></i>
</a>中压缩包。</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/old/rasp_pi_docker/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/posts/old/arm-board-note/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/avatar.jpeg"><meta itemprop=name content="蓝宝石的傻话"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="蓝宝石的傻话"><meta itemprop=description content="What is rational is real; and what is real is rational."></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="ARM的点点滴滴记录"><meta itemprop=description content="Raspberry Pi

我用树莓派搭建docker集群环境，参考

    Hypriot
    
    
    
的博客

CubieBoard



安装docker


选择Hypriot(截止到2017年3月版本是docker 1.11.1)"></span><header class=post-header><h2 class=post-title itemprop="name headline"><a href=/posts/old/arm-board-note/ itemprop=url class=post-title-link>ARM的点点滴滴记录</a></h2><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i>
</span><span class=post-meta-item-text title=发表于>发表于：
</span><time title="创建时间：2017-02-27 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2017-02-27 00:00:00 +0000 UTC">2017-02-27
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i>
</span><span class=post-meta-item-text title=分类于>分类于：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/arm itemprop=url rel=index><span itemprop=name>Arm</span></a></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><h2 id=raspberry-pi>Raspberry Pi
<a class=header-anchor href=#raspberry-pi></a></h2><p>我用树莓派搭建docker集群环境，参考
<a href=http://blog.hypriot.com/ title=Hypriot rel="noopener external nofollow noreferrer" target=_blank class=exturl>Hypriot
<i class="fa fa-external-link-alt"></i>
</a>的博客</p><p><img src=/imgs/img-lazy-loading.gif data-src=/posts/old/images/RaspPi_cluster_only.jpg alt></p><h2 id=cubieboard>CubieBoard
<a class=header-anchor href=#cubieboard></a></h2><ul><li><p>安装docker</p><ul><li><p>选择Hypriot(截止到2017年3月版本是docker 1.11.1)</p></div><footer class=post-footer><div class=post-button><a class=btn href=/posts/old/arm-board-note/#more rel=contents>阅读全文 &#187;</a></div><div class=post-eof></div></footer></article></div><nav class=pagination><span class="page-number current">1</span>
<a class=page-number href=/page/2/>2</a>
<a class="extend next" rel=next href=/page/2/><i class="fa fa-angle-right"></i></a></nav></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2025
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>蓝宝石的傻话</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.145.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备2023145803号</a>
<img src=/imgs/gongan.png alt=粤公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011102001194" target=_blank>粤公网安备 44011102001194 号</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script><script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.b0c78e5a4df586ee46d02716ffa91a4a322e56763e04e91eb2ba052c9469ed02.js defer></script></body></html>